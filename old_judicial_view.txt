def judicial_decisions(request):
    from django.core.cache import cache
    from django.core.paginator import Paginator
    from django.http import JsonResponse
    from django.db import connection
    import time
    
    # AJAX isteği mi kontrol et
    is_ajax = request.headers.get('X-Requested-With') == 'XMLHttpRequest'
    
    query = request.GET.get('q', '').strip()
    page_number = request.GET.get('page', 1)
    
    # Cache anahtarları
    cache_key_counts = 'court_type_counts'
    cache_key_total = 'total_decisions_count'
    cache_key_newest = 'newest_decisions_list'
    
    if query:
        # Çok hızlı PostgreSQL full-text search
        start_time = time.time()
        
        with connection.cursor() as cursor:
            # Full-text search with ranking
            search_sql = """
                SELECT id, karar_turu, karar_veren_mahkeme, esas_numarasi, 
                       karar_numarasi, karar_tarihi, karar_ozeti,
                       ts_rank(to_tsvector('turkish', COALESCE(karar_ozeti, '') || ' ' || 
                                         COALESCE(anahtar_kelimeler, '') || ' ' || 
                                         COALESCE(karar_tam_metni, '')), 
                              plainto_tsquery('turkish', %s)) as rank
                FROM core_judicialdecision 
                WHERE to_tsvector('turkish', COALESCE(karar_ozeti, '') || ' ' || 
                                           COALESCE(anahtar_kelimeler, '') || ' ' || 
                                           COALESCE(karar_tam_metni, '')) 
                      @@ plainto_tsquery('turkish', %s)
                ORDER BY rank DESC, karar_tarihi DESC
                LIMIT %s OFFSET %s
            """
            
            # Sayfa hesaplama
            per_page = 20
            offset = (int(page_number) - 1) * per_page
            
            cursor.execute(search_sql, [query, query, per_page, offset])
            results = cursor.fetchall()
            
            # Toplam sonuç sayısı
            count_sql = """
                SELECT COUNT(*) FROM core_judicialdecision 
                WHERE to_tsvector('turkish', COALESCE(karar_ozeti, '') || ' ' || 
                                           COALESCE(anahtar_kelimeler, '') || ' ' || 
                                           COALESCE(karar_tam_metni, '')) 
                      @@ plainto_tsquery('turkish', %s)
            """
            cursor.execute(count_sql, [query])
            total_results = cursor.fetchone()[0]
        
        # Sonuçları Django objelerine çevir
        decisions = []
        for row in results:
            decision = type('Decision', (), {
                'id': row[0],
                'karar_turu': row[1],
                'karar_veren_mahkeme': row[2],
                'esas_numarasi': row[3],
                'karar_numarasi': row[4],
                'karar_tarihi': row[5],
                'karar_ozeti': row[6],
                'relevance_score': row[7]
            })()
            decisions.append(decision)
        
        # Sayfalama nesnesi oluştur
        from django.core.paginator import Page
        paginator = Paginator(range(total_results), per_page)
        page_obj = paginator.get_page(page_number)
        
        # Mahkeme türü istatistikleri (cache'li)
        cache_key_search_stats = f'search_stats_{hash(query)}'
        court_type_counts = cache.get(cache_key_search_stats)
        
        if court_type_counts is None:
            with connection.cursor() as cursor:
                stats_sql = """
                    SELECT karar_turu, COUNT(*) as total FROM core_judicialdecision 
                    WHERE to_tsvector('turkish', COALESCE(karar_ozeti, '') || ' ' || 
                                               COALESCE(anahtar_kelimeler, '') || ' ' || 
                                               COALESCE(karar_tam_metni, '')) 
                          @@ plainto_tsquery('turkish', %s)
                    GROUP BY karar_turu
                """
                cursor.execute(stats_sql, [query])
                court_type_counts = {row[0]: row[1] for row in cursor.fetchall()}
            cache.set(cache_key_search_stats, court_type_counts, 300)  # 5 dakika
        
        search_time = round((time.time() - start_time) * 1000, 2)
        
        if is_ajax:
            return JsonResponse({
                'results': [{
                    'id': d.id,
                    'karar_turu': d.karar_turu,
                    'karar_veren_mahkeme': d.karar_veren_mahkeme,
                    'esas_numarasi': d.esas_numarasi,
                    'karar_numarasi': d.karar_numarasi,
                    'karar_tarihi': d.karar_tarihi.strftime('%Y-%m-%d') if d.karar_tarihi else '',
                    'karar_ozeti': d.karar_ozeti[:200] + '...' if d.karar_ozeti and len(d.karar_ozeti) > 200 else d.karar_ozeti,
                    'relevance_score': round(d.relevance_score, 3)
                } for d in decisions],
                'pagination': {
                    'current_page': page_obj.number,
                    'total_pages': page_obj.paginator.num_pages,
                    'has_previous': page_obj.has_previous(),
                    'has_next': page_obj.has_next(),
                    'total_results': total_results
                },
                'court_type_counts': court_type_counts,
                'search_time': search_time,
                'total_decisions': total_results
            })
        
        # Custom page object
        class PageObj:
            def __init__(self, decisions, page_obj):
                self.object_list = decisions
                self.number = page_obj.number
                self.paginator = page_obj.paginator
                self._page_obj = page_obj
                
            def has_other_pages(self):
                return self._page_obj.has_other_pages()
                
            def has_previous(self):
                return self._page_obj.has_previous()
                
            def has_next(self):
                return self._page_obj.has_next()
                
            def previous_page_number(self):
                return self._page_obj.previous_page_number() if self._page_obj.has_previous() else None
                
            def next_page_number(self):
                return self._page_obj.next_page_number() if self._page_obj.has_next() else None
                
            def __iter__(self):
                return iter(self.object_list)
                
            def __len__(self):
                return len(self.object_list)
        
        newest_decisions = PageObj(decisions, page_obj)
        
        total_decisions = total_results
        
    else:
        # Arama yoksa cache kullan
        court_type_counts = cache.get(cache_key_counts)
        total_decisions = cache.get(cache_key_total)
        newest_decisions_list = cache.get(cache_key_newest)
        
        if court_type_counts is None or total_decisions is None or newest_decisions_list is None:
            all_queryset = JudicialDecision.objects.all()
            
            court_type_counts_qs = all_queryset.values('karar_turu').annotate(total=Count('id'))
            court_type_counts = {item['karar_turu']: item['total'] for item in court_type_counts_qs}
            
            total_decisions = all_queryset.count()
            
            newest_decisions_list = list(
                all_queryset.select_related().only(
                    'id', 'karar_turu', 'karar_veren_mahkeme', 'esas_numarasi', 
                    'karar_numarasi', 'karar_tarihi', 'karar_ozeti'
                ).order_by('-karar_tarihi')[:100]
            )
            
            cache.set(cache_key_counts, court_type_counts, 1800)
            cache.set(cache_key_total, total_decisions, 1800)
            cache.set(cache_key_newest, newest_decisions_list, 1800)
        
        paginator = Paginator(newest_decisions_list, 20)
        newest_decisions = paginator.get_page(page_number)
        search_time = 0

    context = {
        'query': query,
        'newest_decisions': newest_decisions,
        'court_type_counts': court_type_counts,
        'total_decisions': total_decisions,
        'is_paginated': getattr(newest_decisions, 'has_other_pages', lambda: False)(),
        'search_time': locals().get('search_time', 0),
    }
    return render(request, 'core/judicial_decisions.html', context)



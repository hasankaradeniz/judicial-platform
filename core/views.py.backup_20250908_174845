# core/views.py
from django.shortcuts import render, get_object_or_404, redirect
from django.urls import reverse
from .models import (
    JudicialDecision, Article, Legislation,
    MevzuatGelismis, MevzuatTuru, MevzuatKategori, 
    MevzuatMadde, MevzuatDegisiklik, MevzuatLog
)
from django.db.models import Q
from django.contrib.auth import login
from django.contrib.auth.forms import UserCreationForm
from django.contrib.auth.decorators import login_required
import logging

logger = logging.getLogger(__name__)

# DRF iÃ§in
from rest_framework.decorators import api_view
from rest_framework.response import Response
from .serializers import JudicialDecisionSerializer, ArticleSerializer

# Google API iÃ§in (Google Custom Search)
from googleapiclient.discovery import build
from django.conf import settings
import random
import json
from django.db.models import Count
from django.shortcuts import render
from .models import JudicialDecision
from django.shortcuts import render
from .models import JudicialDecision
from .filters import JudicialDecisionFilter
from django.shortcuts import render
from .models import JudicialDecision
from .filters import JudicialDecisionFilter
import random, json
from django.db.models import Count
from .models import Article
from django.shortcuts import render, redirect
from django.contrib.auth.decorators import login_required
from django.utils import timezone
from .models import Subscription, Payment
from datetime import timedelta, datetime
from django.contrib.auth.decorators import login_required
from .decorators import subscription_required
from django.shortcuts import render, redirect
from django.contrib.auth import login
from .forms import CustomUserCreationForm
from django.utils import timezone
from django.core.mail import send_mail
from django.views.decorators.csrf import csrf_exempt
from django.views.decorators.http import require_POST
from django.http import JsonResponse
from random import sample
from .models import Article
from .param_payment_service import ParamPaymentService
from .param_simple_service import ParamSimpleService

def voice_assistant(request):
    """Sesli asistan ana sayfasÄ±"""
    return render(request, 'core/voice_assistant.html')

# Admin views import
from .admin_views import admin_pdf_upload, admin_mevzuat_list, admin_delete_mevzuat

# External mevzuat views import
from .external_mevzuat_views import external_mevzuat_detail, external_mevzuat_pdf_proxy

# MCP views removed - feature reverted

# Hibrit mevzuat arama
from .hybrid_mevzuat_service import HybridMevzuatService
import requests
from bs4 import BeautifulSoup
from datetime import datetime
from random import sample
from django.shortcuts import render
from .models import JudicialDecision, Article
from django.http import JsonResponse
from django.db.models import Q
from .models import JudicialDecision
# from .nlp_utils import analyze_text  # Commented out due to emoji module dependency
from django.http import JsonResponse
from django.shortcuts import render
from django.db.models import Q
from .models import JudicialDecision
# from .nlp_utils import analyze_text  # Commented out due to emoji module dependency
from django.db.models import Count
from core.models import JudicialDecision, Article
from django.contrib.postgres.search import SearchVector, SearchQuery, SearchRank
from django.shortcuts import render
from core.models import JudicialDecision
import time

def home(request):
    """
    Ana sayfa: Arama formu, en yeni kararlar, rastgele kararlar ve rastgele makaleler.
    """
    from django.core.cache import cache
    from random import sample
    
    # Cache anahtarlarÄ±
    cache_key_newest = 'home_newest_decisions'
    cache_key_random_decisions = 'home_random_decisions'
    cache_key_random_articles = 'home_random_articles'
    cache_key_total = 'home_total_decisions'
    
    # Cache'den veri Ã§ekmeye Ã§alÄ±ÅŸ
    newest_decisions = cache.get(cache_key_newest)
    random_decisions = cache.get(cache_key_random_decisions)
    random_articles = cache.get(cache_key_random_articles)
    total_decisions = cache.get(cache_key_total)
    
    # Cache'de yoksa hesapla
    if newest_decisions is None:
        newest_decisions = list(JudicialDecision.objects.select_related().only(
            'id', 'karar_veren_mahkeme', 'karar_numarasi', 'karar_tarihi', 'karar_ozeti'
        ).order_by('-karar_tarihi')[:10])
        cache.set(cache_key_newest, newest_decisions, 900)  # 15 dakika
    
    if random_decisions is None:
        # order_by('?') yerine Python'da rastgele seÃ§im
        all_decision_ids = list(JudicialDecision.objects.values_list('id', flat=True))
        if len(all_decision_ids) >= 3:
            random_ids = sample(all_decision_ids, min(3, len(all_decision_ids)))
            random_decisions = list(JudicialDecision.objects.filter(id__in=random_ids).select_related().only(
                'id', 'karar_veren_mahkeme', 'karar_numarasi', 'karar_tarihi', 'karar_ozeti'
            ))
        else:
            random_decisions = []
        cache.set(cache_key_random_decisions, random_decisions, 1800)  # 30 dakika
        
    if total_decisions is None:
        total_decisions = JudicialDecision.objects.count()
        cache.set(cache_key_total, total_decisions, 1800)  # 30 dakika

    # Resmi Gazete iÃ§eriklerini getir
    from .resmi_gazete_scraper import get_resmi_gazete_content
    try:
        resmi_gazete_icerikler = get_resmi_gazete_content()
    except Exception as e:
        print(f"Resmi Gazete iÃ§erikleri alÄ±nÄ±rken hata: {e}")
        resmi_gazete_icerikler = []

    context = {
        'newest_decisions': newest_decisions,
        'random_decisions': random_decisions,
        'resmi_gazete_icerikler': resmi_gazete_icerikler,
        'total_decisions': total_decisions,
    }

    return render(request, 'core/home.html', context)



def about(request):
    """
    HakkÄ±nda sayfasÄ±: Platformunuzun tarihÃ§esi, misyonu ve vizyonu.
    """
    return render(request, 'core/about.html')

def combined_search_results(request):
    query = request.GET.get('q', '')
    area = request.GET.get('area', 'both')  # varsayÄ±lan "both", yani tÃ¼m alanlarda arama

    judicial_results = JudicialDecision.objects.none()
    legislation_results = Legislation.objects.none()
    article_results = Article.objects.none()

    if query:
        if area in ['judicial', 'both']:
            judicial_results = JudicialDecision.objects.filter(
                Q(karar_ozeti__icontains=query) |
                Q(anahtar_kelimeler__icontains=query) |
                Q(karar_tam_metni__icontains=query)
            )
        if area in ['legislation', 'both']:
            legislation_results = Legislation.objects.filter(
                Q(baslik__icontains=query) |
                Q(konu__icontains=query)
            )
        if area in ['articles', 'both']:
            article_results = Article.objects.filter(
                Q(makale_basligi__icontains=query) |
                Q(makale_ozeti__icontains=query) |
                Q(makale_metni__icontains=query)
            )

    context = {
        'query': query,
        'area': area,
        'judicial_results': judicial_results,
        'legislation_results': legislation_results,
        'article_results': article_results,
    }
    return render(request, 'core/combined_search_results.html', context)


from django.db.models import Count, Q
from core.models import JudicialDecision
import logging

logger = logging.getLogger(__name__)

def judicial_decisions(request):
    from django.core.cache import cache
    from django.core.paginator import Paginator
    from django.http import JsonResponse
    from django.db import connection
    import time
    
    # AJAX isteÄŸi mi kontrol et
    is_ajax = request.headers.get('X-Requested-With') == 'XMLHttpRequest'
    
    query = request.GET.get('q', '').strip()
    page_number = request.GET.get('page', 1)
    
    # Initialize variables to avoid UnboundLocalError
    newest_decisions = None
    court_type_counts = {}
    total_decisions = 0
    search_time = 0
    
    # GeliÅŸmiÅŸ filtreler
    court_type = request.GET.get('court_type', '').strip()
    chamber = request.GET.get('chamber', '').strip()
    date_range = request.GET.get('date_range', '').strip()
    decision_number = request.GET.get('decision_number', '').strip()
    case_number = request.GET.get('case_number', '').strip()
    sort_order = request.GET.get('sort_order', 'relevance')
    per_page = int(request.GET.get('per_page', '20'))
    
    # Cache anahtarlarÄ±
    cache_key_counts = 'court_type_counts'
    cache_key_total = 'total_decisions_count'
    cache_key_newest = 'newest_decisions_list'
    
    # Herhangi bir filtre veya arama varsa
    if query or court_type or chamber or date_range or decision_number or case_number:
        # Ã‡ok hÄ±zlÄ± PostgreSQL search
        start_time = time.time()
        
        with connection.cursor() as cursor:
            # Base SQL
            select_sql = """
                SELECT id, karar_turu, karar_veren_mahkeme, esas_numarasi, 
                       karar_numarasi, karar_tarihi, karar_ozeti"""
            
            from_sql = " FROM core_judicialdecision"
            where_clauses = []
            params = []
            
            # Full-text search varsa
            if query:
                select_sql += """,
                       ts_rank(to_tsvector('turkish', COALESCE(karar_ozeti, '') || ' ' || 
                                         COALESCE(anahtar_kelimeler, '') || ' ' || 
                                         COALESCE(karar_tam_metni, '')), 
                              plainto_tsquery('turkish', %s)) as rank"""
                where_clauses.append("""
                    to_tsvector('turkish', COALESCE(karar_ozeti, '') || ' ' || 
                                          COALESCE(anahtar_kelimeler, '') || ' ' || 
                                          COALESCE(karar_tam_metni, '')) 
                    @@ plainto_tsquery('turkish', %s)
                """)
                params.extend([query, query])
            else:
                select_sql += ", 0 as rank"
            
            # Mahkeme tÃ¼rÃ¼ filtresi
            if court_type:
                where_clauses.append("karar_turu = %s")
                params.append(court_type)
            
            # Daire filtresi
            if chamber:
                where_clauses.append("karar_veren_mahkeme ILIKE %s")
                params.append(f'%{chamber}%')
            
            # Tarih aralÄ±ÄŸÄ± filtresi
            if date_range:
                from datetime import datetime, timedelta
                today = datetime.now().date()
                
                if date_range == 'today':
                    where_clauses.append("karar_tarihi = %s")
                    params.append(today)
                elif date_range == 'week':
                    where_clauses.append("karar_tarihi >= %s")
                    params.append(today - timedelta(days=7))
                elif date_range == 'month':
                    where_clauses.append("karar_tarihi >= %s")
                    params.append(today - timedelta(days=30))
                elif date_range == '3months':
                    where_clauses.append("karar_tarihi >= %s")
                    params.append(today - timedelta(days=90))
                elif date_range == '6months':
                    where_clauses.append("karar_tarihi >= %s")
                    params.append(today - timedelta(days=180))
                elif date_range == 'year':
                    where_clauses.append("karar_tarihi >= %s")
                    params.append(today - timedelta(days=365))
            
            # Karar numarasÄ± filtresi
            if decision_number:
                where_clauses.append("karar_numarasi ILIKE %s")
                params.append(f'%{decision_number}%')
            
            # Esas numarasÄ± filtresi
            if case_number:
                where_clauses.append("esas_numarasi ILIKE %s")
                params.append(f'%{case_number}%')
            
            # WHERE clause oluÅŸtur
            if where_clauses:
                where_sql = " WHERE " + " AND ".join(where_clauses)
            else:
                where_sql = ""
            
            # ORDER BY
            if sort_order == 'date_desc':
                order_sql = " ORDER BY karar_tarihi DESC"
            elif sort_order == 'date_asc':
                order_sql = " ORDER BY karar_tarihi ASC"
            elif sort_order == 'court_alpha':
                order_sql = " ORDER BY karar_veren_mahkeme ASC"
            elif sort_order == 'decision_number':
                order_sql = " ORDER BY karar_numarasi DESC"
            elif query:  # relevance sÄ±ralamasÄ± sadece arama varsa
                order_sql = " ORDER BY rank DESC, karar_tarihi DESC"
            else:
                order_sql = " ORDER BY karar_tarihi DESC"
            
            # Sayfa hesaplama
            offset = (int(page_number) - 1) * per_page
            
            # SQL'i birleÅŸtir
            full_sql = select_sql + from_sql + where_sql + order_sql + " LIMIT %s OFFSET %s"
            params.extend([per_page, offset])
            
            # Query timeout ayarla (30 saniye)
            cursor.execute("SET statement_timeout = '30s'")
            
            # Performance iÃ§in LIMIT optimize et
            max_search_limit = 10000  # Ã‡ok bÃ¼yÃ¼k sonuÃ§larÄ± sÄ±nÄ±rla
            
            try:
                cursor.execute(full_sql, params)
                results = cursor.fetchall()
                
                # Toplam sonuÃ§ sayÄ±sÄ± iÃ§in optimize edilmiÅŸ count
                # Ã‡ok bÃ¼yÃ¼k sonuÃ§lar iÃ§in estimate kullan
                if where_clauses:  # Filtre varsa tam count
                    count_sql = "SELECT COUNT(*) FROM core_judicialdecision" + where_sql
                    count_params = params[:-2] if params else []
                    cursor.execute(count_sql, count_params)
                    total_results = cursor.fetchone()[0]
                    
                    # Ã‡ok bÃ¼yÃ¼k sonuÃ§ setlerini sÄ±nÄ±rla
                    if total_results > max_search_limit:
                        total_results = max_search_limit
                else:  # Filtre yoksa estimate count kullan (Ã§ok hÄ±zlÄ±)
                    cursor.execute("SELECT reltuples::BIGINT AS estimate FROM pg_class WHERE relname = 'core_judicialdecision'")
                    total_results = cursor.fetchone()[0] or 0
                
            except Exception as e:
                # Query timeout veya hata durumunda boÅŸ sonuÃ§ dÃ¶ndÃ¼r
                import logging
                logger = logging.getLogger(__name__)
                logger.error(f"Database query error: {str(e)}")
                results = []
                total_results = 0
                count_params = []
            finally:
                # Timeout'u resetle
                cursor.execute("RESET statement_timeout")
        
        # SonuÃ§larÄ± Django objelerine Ã§evir
        decisions = []
        for row in results:
            decision = type('Decision', (), {
                'id': row[0],
                'karar_turu': row[1],
                'karar_veren_mahkeme': row[2],
                'esas_numarasi': row[3],
                'karar_numarasi': row[4],
                'karar_tarihi': row[5],
                'karar_ozeti': row[6],
                'relevance_score': row[7] if len(row) > 7 else 0
            })()
            decisions.append(decision)
        
        # Sayfalama nesnesi oluÅŸtur
        from django.core.paginator import Page
        paginator = Paginator(range(total_results), per_page)
        page_obj = paginator.get_page(page_number)
        
        # Mahkeme tÃ¼rÃ¼ istatistikleri (cache'li)
        filter_key = f"{query}_{court_type}_{chamber}_{date_range}_{decision_number}_{case_number}"
        cache_key_search_stats = f'search_stats_{hash(filter_key)}'
        court_type_counts = cache.get(cache_key_search_stats)
        
        if court_type_counts is None:
            with connection.cursor() as cursor:
                stats_sql = "SELECT karar_turu, COUNT(*) as total FROM core_judicialdecision" + where_sql + " GROUP BY karar_turu"
                # count_params tanÄ±mÄ±nÄ± gÃ¼venli hale getir
                safe_count_params = locals().get('count_params', params[:-2] if params else [])
                cursor.execute(stats_sql, safe_count_params)
                court_type_counts = {row[0]: row[1] for row in cursor.fetchall()}
            cache.set(cache_key_search_stats, court_type_counts, 300)  # 5 dakika
        
        search_time = round((time.time() - start_time) * 1000, 2)
        
        if is_ajax:
            return JsonResponse({
                'results': [{
                    'id': d.id,
                    'karar_turu': d.karar_turu,
                    'karar_veren_mahkeme': d.karar_veren_mahkeme,
                    'esas_numarasi': d.esas_numarasi,
                    'karar_numarasi': d.karar_numarasi,
                    'karar_tarihi': d.karar_tarihi.strftime('%Y-%m-%d') if d.karar_tarihi else '',
                    'karar_ozeti': d.karar_ozeti[:200] + '...' if d.karar_ozeti and len(d.karar_ozeti) > 200 else d.karar_ozeti,
                    'relevance_score': round(d.relevance_score, 3)
                } for d in decisions],
                'pagination': {
                    'current_page': page_obj.number,
                    'total_pages': page_obj.paginator.num_pages,
                    'has_previous': page_obj.has_previous(),
                    'has_next': page_obj.has_next(),
                    'total_results': total_results
                },
                'court_type_counts': court_type_counts,
                'search_time': search_time,
                'total_decisions': total_results
            })
        
        # Custom page object
        class PageObj:
            def __init__(self, decisions, page_obj):
                self.object_list = decisions
                self.number = page_obj.number
                self.paginator = page_obj.paginator
                self._page_obj = page_obj
                
            def has_other_pages(self):
                return self._page_obj.has_other_pages()
                
            def has_previous(self):
                return self._page_obj.has_previous()
                
            def has_next(self):
                return self._page_obj.has_next()
                
            def previous_page_number(self):
                return self._page_obj.previous_page_number() if self._page_obj.has_previous() else None
                
            def next_page_number(self):
                return self._page_obj.next_page_number() if self._page_obj.has_next() else None
                
            def __iter__(self):
                return iter(self.object_list)
                
            def __len__(self):
                return len(self.object_list)
        
        try:
            newest_decisions = PageObj(decisions, page_obj)
        except Exception as e:
            # Fallback if PageObj creation fails
            import logging
            logger = logging.getLogger(__name__)
            logger.error(f"PageObj creation error: {str(e)}")
            newest_decisions = decisions[:15]  # Simple fallback
        
        total_decisions = total_results
        
    else:
        # Arama yoksa cache kullan
        court_type_counts = cache.get(cache_key_counts)
        total_decisions = cache.get(cache_key_total)
        newest_decisions_list = cache.get(cache_key_newest)
        
        if court_type_counts is None or total_decisions is None or newest_decisions_list is None:
            all_queryset = JudicialDecision.objects.all()
            
            court_type_counts_qs = all_queryset.values('karar_turu').annotate(total=Count('id'))
            court_type_counts = {item['karar_turu']: item['total'] for item in court_type_counts_qs}
            
            total_decisions = all_queryset.count()
            
            newest_decisions_list = list(
                all_queryset.select_related().only(
                    'id', 'karar_turu', 'karar_veren_mahkeme', 'esas_numarasi', 
                    'karar_numarasi', 'karar_tarihi', 'karar_ozeti'
                ).order_by('-karar_tarihi')[:100]
            )
            
            cache.set(cache_key_counts, court_type_counts, 1800)
            cache.set(cache_key_total, total_decisions, 1800)
            cache.set(cache_key_newest, newest_decisions_list, 1800)
        
        paginator = Paginator(newest_decisions_list, 20)
        newest_decisions = paginator.get_page(page_number)
        search_time = 0

    # Herhangi bir filtre var mÄ± kontrol et
    has_any_filter = bool(query or court_type or chamber or date_range or decision_number or case_number)
    
    # Final safety check for newest_decisions
    if newest_decisions is None:
        newest_decisions = []
    
    context = {
        'query': query,
        'newest_decisions': newest_decisions,
        'court_type_counts': court_type_counts,
        'total_decisions': total_decisions,
        'is_paginated': getattr(newest_decisions, 'has_other_pages', lambda: False)(),
        'search_time': locals().get('search_time', 0),
        'has_filters': has_any_filter,
        'court_type': court_type,
        'chamber': chamber,
        'date_range': date_range,
        'decision_number': decision_number,
        'case_number': case_number,
        'sort_order': sort_order,
        'per_page': per_page,
    }
    return render(request, 'core/judicial_decisions.html', context)


def articles(request):
    """Harici kaynaklardan makale arama ana sayfasÄ±"""
    # VeritabanÄ± kullanmÄ±yoruz, sadece arama formu gÃ¶steriyoruz
    context = {}
    return render(request, 'core/articles.html', context)


def article_detail(request, pk):
    """Makale detay sayfasÄ±"""
    article = get_object_or_404(Article, pk=pk)
    context = {'article': article}
    return render(request, 'core/article_detail.html', context)

def article_search_results(request):
    """
    Akademik makale arama sonuÃ§larÄ± - Sadece gÃ¼venilir API'ler
    """
    from .simple_article_search import SimpleArticleSearcher, get_sample_articles
    import time
    
    query = request.GET.get('q', '').strip()
    page = int(request.GET.get('page', 1))
    articles = []
    search_time = 0
    error_message = ""
    total_estimated = 0
    
    if query:
        start_time = time.time()
        try:
            print(f"ğŸ” '{query}' iÃ§in akademik makale aranÄ±yor (sayfa {page})...")
            
            # Yeni basit ve gÃ¼venilir sistem - paginated
            searcher = SimpleArticleSearcher()
            articles = searcher.search_articles(query, limit=10, page=page)
            
            print(f"ğŸ” API'den dÃ¶nen makale sayÄ±sÄ±: {len(articles)}")
            
            # Toplam sonuÃ§ tahmini (CrossRef iÃ§in genel tahmin)
            if articles and len(articles) > 0:
                total_estimated = 2500  # Genel tahmin - gerÃ§ek API'den gelebilir
            
            # SonuÃ§larÄ± deÄŸerlendir
            if not articles or len(articles) == 0:
                if page == 1:
                    print(f"âŒ '{query}' iÃ§in hiÃ§ makale bulunamadÄ±, Ã¶rnek makaleler gÃ¶steriliyor")
                    articles = get_sample_articles(query, limit=10)
                    print(f"ğŸ“š {len(articles)} Ã¶rnek makale oluÅŸturuldu")
                    total_estimated = 3  # Sadece Ã¶rnek makaleler
                else:
                    print(f"âŒ Sayfa {page} iÃ§in makale bulunamadÄ±")
                    articles = []
                    total_estimated = 0
            else:
                print(f"âœ… {len(articles)} gerÃ§ek akademik makale bulundu (sayfa {page})")
                
                # Ã–zet Ã§ekme iÅŸlemi (sadece ilk sayfa iÃ§in)
                if page == 1:
                    for i, article in enumerate(articles):
                        if article.get('abstract') == 'Ã–zet yÃ¼kleniyor...' and article.get('detail_link'):
                            print(f"ğŸ“„ {i+1}. makale iÃ§in Ã¶zet Ã§ekiliyor...")
                            abstract = searcher.fetch_abstract_from_url(article['detail_link'])
                            if abstract:
                                article['abstract'] = abstract
                                print(f"âœ… Ã–zet baÅŸarÄ±yla Ã§ekildi: {abstract[:50]}...")
                            else:
                                article['abstract'] = 'Bu makale iÃ§in Ã¶zet Ã§ekilemedi.'
                
            # Session'a kaydet
            for article in articles:
                article_id = article.get('id')
                if article_id:
                    request.session[f'article_{article_id}'] = article
            request.session.save()
            
        except Exception as e:
            print(f"âŒ Makale arama hatasÄ±: {str(e)}")
            error_message = f"Arama hatasÄ±: {str(e)}"
            articles = get_sample_articles(query, limit=10)
        
        search_time = round((time.time() - start_time) * 1000, 2)

    # Custom pagination logic for API-based results
    has_next = len(articles) == 10 and page * 10 < total_estimated
    has_previous = page > 1
    
    # Sayfa numaralarÄ± (basit pagination)
    page_range = []
    if total_estimated > 0:
        total_pages = min((total_estimated + 9) // 10, 250)  # Maksimum 250 sayfa
        start_page = max(1, page - 2)
        end_page = min(total_pages, page + 2)
        page_range = list(range(start_page, end_page + 1))

    context = {
        'query': query,
        'articles': articles,
        'search_time': search_time,
        'total_results': total_estimated,
        'error_message': error_message,
        'search_sources': ['CrossRef API', 'DOAJ API'],
        # Pagination info
        'current_page': page,
        'has_next': has_next,
        'has_previous': has_previous,
        'next_page': page + 1 if has_next else None,
        'previous_page': page - 1 if has_previous else None,
        'page_range': page_range,
        'total_pages': (total_estimated + 9) // 10 if total_estimated > 0 else 0,
        'start_index': (page - 1) * 10 + 1,
        'end_index': min(page * 10, total_estimated),
    }
    return render(request, 'core/article_search_results.html', context)


def sitemap_xml(request):
    """Sitemap.xml dosyasÄ±"""
    from django.http import HttpResponse
    from django.urls import reverse
    
    sitemap_content = '''<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.sitemaps.org/schemas/sitemap/0.9
        http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd">
    
    <url>
        <loc>https://sozlesme.online/</loc>
        <lastmod>2024-12-12</lastmod>
        <changefreq>daily</changefreq>
        <priority>1.0</priority>
    </url>
    
    <url>
        <loc>https://sozlesme.online/articles/</loc>
        <lastmod>2024-12-12</lastmod>
        <changefreq>daily</changefreq>
        <priority>0.9</priority>
    </url>
    
    <url>
        <loc>https://sozlesme.online/judicial-decisions/</loc>
        <lastmod>2024-12-12</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.8</priority>
    </url>
    
    <url>
        <loc>https://sozlesme.online/legislation/</loc>
        <lastmod>2024-12-12</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.8</priority>
    </url>
    
    <url>
        <loc>https://sozlesme.online/ai/</loc>
        <lastmod>2024-12-12</lastmod>
        <changefreq>monthly</changefreq>
        <priority>0.7</priority>
    </url>
    
    <url>
        <loc>https://sozlesme.online/about/</loc>
        <lastmod>2024-12-12</lastmod>
        <changefreq>monthly</changefreq>
        <priority>0.6</priority>
    </url>
    
    <url>
        <loc>https://sozlesme.online/paketler/</loc>
        <lastmod>2024-12-12</lastmod>
        <changefreq>monthly</changefreq>
        <priority>0.5</priority>
    </url>
    
</urlset>'''
    
    return HttpResponse(sitemap_content, content_type='application/xml')


def robots_txt(request):
    """Robots.txt dosyasÄ±"""
    from django.http import HttpResponse
    
    robots_content = '''User-agent: *
Allow: /

# Disallow certain admin and private areas
Disallow: /admin/
Disallow: /accounts/
Disallow: /static/admin/

# Allow important crawlable content
Allow: /articles/
Allow: /judicial-decisions/
Allow: /legislation/
Allow: /ai/
Allow: /static/

# Crawl settings
Crawl-delay: 1

# Sitemap location
Sitemap: https://sozlesme.online/sitemap.xml'''
    
    return HttpResponse(robots_content, content_type='text/plain')

def article_pdf_viewer(request, source, article_id):
    """
    Makale PDF gÃ¶rÃ¼ntÃ¼leyici - GerÃ§ekÃ§i akademik PDF oluÅŸturma sistemi
    """
    from .external_articles_search import ExternalArticleSearcher
    from .academic_pdf_generator import AcademicPDFGenerator
    from django.http import HttpResponse
    from django.core.files.storage import default_storage
    
    # Cache'den makale verilerini al (simÃ¼lasyon sistemi)
    article = None
    
    # Makale bilgilerini URL parametrelerinden ve session'dan al
    try:
        # Ã–nce session'dan kontrol et
        session_key = f'article_{article_id}'
        if session_key in request.session:
            article = request.session[session_key]
            print(f"Makale session'dan bulundu: {article.get('title', 'N/A')}")
        else:
            # Session'da yoksa cache'den ara
            from django.core.cache import cache
            all_cache_keys = []
            
            # Cache backend'e gÃ¶re keys alma
            try:
                if hasattr(cache, '_cache'):
                    all_cache_keys = list(cache._cache.keys())
                elif hasattr(cache, 'keys'):
                    all_cache_keys = cache.keys('external_articles_*')
            except:
                pass
            
            found = False
            for key in all_cache_keys:
                if 'external_articles_' in str(key):
                    cached_articles = cache.get(key, [])
                    if cached_articles:
                        for art in cached_articles:
                            if art.get('id') == article_id:
                                article = art
                                found = True
                                print(f"Makale cache'den bulundu: {article.get('title', 'N/A')}")
                                break
                    if found:
                        break
                    
    except Exception as e:
        print(f"Makale arama hatasÄ±: {e}")
    
    if not article:
        # Genel bir Ã¶rnek makale oluÅŸtur
        article = {
            'id': article_id,
            'title': 'TÃ¼rk Hukuk Sisteminde Modern YaklaÅŸÄ±mlar',
            'authors': 'Prof. Dr. Hukuk UzmanÄ±',
            'journal': 'Ankara Hukuk FakÃ¼ltesi Dergisi',
            'year': '2024',
            'source': source,
            'source_icon': 'ğŸ‡¹ğŸ‡·' if source == 'trdizin' else 'ğŸ“š',
            'abstract': 'Bu Ã§alÄ±ÅŸmada TÃ¼rk hukuk sisteminin modern yaklaÅŸÄ±mlarÄ± ele alÄ±nmÄ±ÅŸ ve mevcut dÃ¼zenlemelerin etkinliÄŸi deÄŸerlendirilmiÅŸtir.'
        }
    
    # PDF oluÅŸturma iÅŸlemi
    pdf_generator = AcademicPDFGenerator()
    pdf_path = None
    
    try:
        # Akademik PDF oluÅŸtur
        pdf_path = pdf_generator.create_academic_pdf(article)
        
        if pdf_path:
            # PDF URL'ini oluÅŸtur
            pdf_url = default_storage.url(pdf_path)
        else:
            # Fallback - HTML gÃ¶rÃ¼ntÃ¼leme
            pdf_url = None
            
    except Exception as e:
        print(f"PDF oluÅŸturma hatasÄ±: {str(e)}")
        # Hata durumunda fallback PDF
        pdf_url = 'https://www.mevzuat.gov.tr/File/GeneratePdf?mevzuatNo=4721&mevzuatTur=1&mevzuatTertip=5'
        pdf_path = None
    
    # PDF doÄŸrudan gÃ¶rÃ¼ntÃ¼leme seÃ§eneÄŸi
    if request.GET.get('view') == 'pdf' and pdf_path:
        try:
            with default_storage.open(pdf_path, 'rb') as pdf_file:
                response = HttpResponse(pdf_file.read(), content_type='application/pdf')
                response['Content-Disposition'] = f'inline; filename="{article.get("title", "academic_article")}.pdf"'
                return response
        except Exception as e:
            print(f"PDF gÃ¶rÃ¼ntÃ¼leme hatasÄ±: {str(e)}")
    
    # GerÃ§ek makale iframe gÃ¶rÃ¼ntÃ¼leme
    if request.GET.get('view') == 'html' or request.GET.get('view') == 'iframe':
        # GerÃ§ek makale linkini iframe ile gÃ¶ster
        original_url = article.get('detail_link') or article.get('pdf_link')
        
        # EÄŸer DOI linki varsa, doÄŸrudan DOI sayfasÄ±nÄ± gÃ¶ster
        if article.get('doi'):
            original_url = f"https://doi.org/{article.get('doi')}"
        
        context = {
            'article': article,
            'original_url': original_url,
            'source': source,
            'article_id': article_id,
            'is_iframe_view': True
        }
        
        return render(request, 'core/article_iframe_viewer.html', context)
    
    # Kaynak adÄ± belirleme
    if source.lower() == 'trdizin':
        source_name = 'TRDizin'
    else:
        source_name = 'DergiPark'
    
    # Ã–nceki arama query'sini al
    search_query = request.GET.get('q', '')
    
    context = {
        'article': article,
        'pdf_url': pdf_url,
        'source': source,
        'source_name': source_name,
        'article_id': article_id,
        'search_query': search_query,
        'has_generated_pdf': pdf_path is not None,
        'html_view_url': f"{request.path}?view=html",
        'pdf_view_url': f"{request.path}?view=pdf" if pdf_path else None,
    }
    
    return render(request, 'core/article_pdf_viewer.html', context)

def hybrid_search_view(request):
    q = request.GET.get("q", "").strip()
    mahkeme = request.GET.get("mahkeme", "").strip()
    tarih = request.GET.get("tarih", "").strip()
    esas = request.GET.get("esas", "").strip()
    karar = request.GET.get("karar", "").strip()

    queryset = JudicialDecision.objects.all()

    # Full-text search varsa
    if q:
        vector = SearchVector('karar_ozeti', 'anahtar_kelimeler', 'karar_tam_metni', config='turkish')
        query = SearchQuery(q, config='turkish')
        queryset = queryset.annotate(rank=SearchRank(vector, query)).filter(rank__gte=0.1).order_by('-rank')

    # YapÄ±sal filtreler (full-text olsa da Ã§alÄ±ÅŸÄ±r)
    if mahkeme:
        queryset = queryset.filter(karar_veren_mahkeme__icontains=mahkeme)
    if tarih:
        queryset = queryset.filter(karar_tarihi=tarih)
    if esas:
        queryset = queryset.filter(esas_numarasi__icontains=esas)
    if karar:
        queryset = queryset.filter(karar_numarasi__icontains=karar)

    return render(request, 'core/hybrid_search_results.html', {
        'results': queryset,
        'query': q,
        'mahkeme': mahkeme,
        'tarih': tarih,
        'esas': esas,
        'karar': karar,
    })

def nlp_search(request):
    if request.method == "GET":
        # KullanÄ±cÄ±ya arama formunu gÃ¶steriyoruz.
        return render(request, "core/nlp_search.html")
    elif request.method == "POST":
        text = request.POST.get("text", "")
        if not text:
            return JsonResponse({"error": "Metin girilmedi"}, status=400)

        # TÃ¼rkÃ§e metni Stanza ile analiz ediyoruz.
        # entities = analyze_text(text)  # Commented out due to dependency issues
        
        # Simple keyword extraction as fallback
        import re
        words = re.findall(r'\b\w+\b', text.lower())
        entities = [word for word in words if len(word) > 3]

        # Ã–rneÄŸin, tespit edilen ilk varlÄ±ÄŸÄ± kullanarak arama yapÄ±yoruz.
        if entities:
            keyword = entities[0]
            decisions = JudicialDecision.objects.filter(
                Q(karar_ozeti__icontains=keyword) |
                Q(anahtar_kelimeler__icontains=keyword) |
                Q(karar_tam_metni__icontains=keyword)
            )
        else:
            decisions = JudicialDecision.objects.none()

        results = []
        for decision in decisions:
            results.append({
                "id": decision.id,
                "karar_veren_mahkeme": decision.karar_veren_mahkeme,
                "karar_numarasi": decision.karar_numarasi,
                "karar_tarihi": decision.karar_tarihi.strftime("%Y-%m-%d") if decision.karar_tarihi else "",
                "karar_ozeti": decision.karar_ozeti,
            })

        return JsonResponse({"entities": entities, "results": results})
    else:
        return JsonResponse({"error": "YalnÄ±zca GET ve POST metotlarÄ± desteklenir"}, status=405)

def legislation(request):
    """
    Mevzuat sayfasÄ±: Kanun, yÃ¶netmelik, tÃ¼zÃ¼k gibi mevzuat bilgilerini listeleyen sayfa.
    """
    legislations = []  # Mevzuat veritabanÄ± sorgularÄ±nÄ±zÄ± buraya ekleyin.
    context = {'legislations': legislations}
    return render(request, 'core/legislation_home.html', context)

def how_it_works(request):
    """
    "NasÄ±l Ã‡alÄ±ÅŸÄ±r?" sayfasÄ±: Platformunuzun iÅŸleyiÅŸini aÃ§Ä±klayan bilgiler.
    """
    return render(request, 'core/how_it_works.html')

def paketler(request):
    return render(request, 'core/paketler.html')

def other_products(request):
    """
    "DiÄŸer ÃœrÃ¼nlerimiz" sayfasÄ±: DiÄŸer ÃœrÃ¼nler.
    """
    return render(request, 'core/other_products.html')

@login_required
def profile(request):
    """
    KullanÄ±cÄ± profil sayfasÄ±: GiriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ±larÄ±n bilgilerini gÃ¶rÃ¼ntÃ¼leme.
    """
    return render(request, 'core/profile.html')


def api_search(request):
    """API arama endpoint"""
    query = request.GET.get('q', '')
    if not query:
        return JsonResponse({'results': []})
    
    decisions = JudicialDecision.objects.filter(
        Q(karar_ozeti__icontains=query) |
        Q(anahtar_kelimeler__icontains=query)
    )[:10]
    
    results = []
    for decision in decisions:
        results.append({
            'id': decision.id,
            'title': decision.karar_turu,
            'summary': decision.karar_ozeti[:200] if decision.karar_ozeti else '',
            'court': decision.karar_veren_mahkeme,
            'date': str(decision.karar_tarihi) if decision.karar_tarihi else ''
        })
    
    return JsonResponse({'results': results})

def search_results(request):
    queryset = JudicialDecision.objects.all()
    decision_filter = JudicialDecisionFilter(request.GET, queryset=queryset)
    results = decision_filter.qs

    # Ek bÃ¶lÃ¼mler (en yeni kararlar, rastgele kararlar, trend analizi)
    newest_decisions = list(results.order_by('-karar_tarihi')[:3])
    all_decisions = list(JudicialDecision.objects.all())
    random_count = min(len(all_decisions), 3)
    random_decisions = random.sample(all_decisions, random_count) if random_count > 0 else []
    total_decisions = JudicialDecision.objects.count()
    court_counts_qs = JudicialDecision.objects.values('karar_turu').annotate(total=Count('id'))
    court_counts = {item['karar_turu']: item['total'] for item in court_counts_qs}
    court_counts_json = json.dumps(court_counts)

    context = {
        'filter': decision_filter,
        'results': results,
        'newest_decisions': newest_decisions,
        'random_decisions': random_decisions,
        'total_decisions': total_decisions,
        'court_counts': court_counts_json,
    }
    return render(request, 'core/search_results.html', context)


@login_required
def subscription_payment(request, package):
    """
    KullanÄ±cÄ±nÄ±n Ã¶deme yaparak abonelik satÄ±n aldÄ±ÄŸÄ± view.
    Param Sanal Pos entegrasyonu ile Ã¶deme iÅŸlemi.
    """
    # BasitleÅŸtirilmiÅŸ servisi kullan
    param_service = ParamSimpleService()
    
    if request.method == "POST":
        accepted_terms = request.POST.get('accepted_terms') == 'on'
        accepted_sale = request.POST.get('accepted_sale') == 'on'
        accepted_delivery = request.POST.get('accepted_delivery') == 'on'
        tc_or_vergi_no = request.POST.get('tc_or_vergi_no')
        address = request.POST.get('address')
        customer_name = request.POST.get('customer_name')
        customer_phone = request.POST.get('customer_phone')

        # SÃ¶zleÅŸmelerin hepsi kabul edilmediyse hata gÃ¶ster
        if not (accepted_terms and accepted_sale and accepted_delivery):
            error = "LÃ¼tfen tÃ¼m sÃ¶zleÅŸmeleri kabul edin."
            return render(request, 'core/subscription_payment.html', {'error': error, 'package': package})

        # Gerekli alanlar doldurulmuÅŸ mu kontrol et
        if not all([tc_or_vergi_no, address, customer_name, customer_phone]):
            error = "LÃ¼tfen tÃ¼m alanlarÄ± doldurun."
            return render(request, 'core/subscription_payment.html', {'error': error, 'package': package})

        # KullanÄ±cÄ± bilgilerini hazÄ±rla (kart bilgileri test iÃ§in)
        user_data = {
            'name': customer_name,
            'phone': customer_phone,
            'address': address,
            'tc_or_vergi_no': tc_or_vergi_no,
            # Test kart bilgileri (production'da form'dan alÄ±nacak)
            'card_owner': customer_name,
            'card_number': '4022774022774026',
            'expire_month': '12',
            'expire_year': '2026',
            'cvc': '000',
            'gsm': customer_phone if customer_phone.startswith('5') else f'5{customer_phone[-9:]}'
        }

        # Ã–deme kaydÄ± oluÅŸtur
        amount = param_service.get_package_amount(package) / 100  # KuruÅŸtan TL'ye Ã§evir
        order_id = f"LEX_{datetime.now().strftime('%Y%m%d_%H%M%S')}_{request.user.id}"
        
        payment = Payment.objects.create(
            user=request.user,
            package=package,
            amount=amount,
            order_id=order_id,
            status='pending'
        )

        # BasitleÅŸtirilmiÅŸ servis ile Ã¶deme baÅŸlat
        payment_result = param_service.start_payment(request, package, user_data)
        
        # Ã–deme bilgilerini session'a kaydet
        request.session['payment_data'] = {
            'payment_id': payment.id,
            'order_id': payment_result.get('order_id', order_id),
            'accepted_terms': accepted_terms,
            'accepted_sale': accepted_sale,
            'accepted_delivery': accepted_delivery,
            'tc_or_vergi_no': tc_or_vergi_no,
            'address': address,
            'customer_name': customer_name,
            'customer_phone': customer_phone,
        }

        # Ã–deme URL'i baÅŸarÄ±lÄ± mÄ± kontrol et
        if payment_result['success']:
            if payment_result.get('requires_redirect'):
                # 3D Secure veya demo sayfasÄ±na redirect et
                return redirect(payment_result['payment_url'])
            else:
                # Direct payment success
                return redirect('payment_success')
        else:
            # Hata durumunda form sayfasÄ±nÄ± tekrar gÃ¶ster
            error = payment_result.get('error', 'Ã–deme iÅŸlemi baÅŸlatÄ±lamadÄ±')
            context = {
                'error': error,
                'package': package,
                'amount': param_service.get_package_amount(package) / 100,
                'package_name': param_service.get_package_description(package),
            }
            return render(request, 'core/subscription_payment.html', context)

    # Paket bilgilerini context'e ekle
    context = {
        'package': package,
        'amount': param_service.get_package_amount(package) / 100,
        'package_name': param_service.get_package_description(package),
    }
    return render(request, 'core/subscription_payment.html', context)

@csrf_exempt
@require_POST
def payment_success(request):
    """
    Param Pos'dan gelen baÅŸarÄ±lÄ± Ã¶deme callback'i
    """
    param_service = ParamPaymentService()
    
    try:
        # POST verilerini al
        response_data = request.POST.dict()
        
        # Ã–deme sonucunu doÄŸrula
        verification_result = param_service.verify_payment_callback(response_data)
        
        if verification_result['success']:
            # Ã–deme kaydÄ±nÄ± gÃ¼ncelle
            try:
                payment = Payment.objects.get(order_id=verification_result['order_id'])
                payment.status = 'success'
                payment.transaction_id = verification_result.get('transaction_id')
                payment.param_response = response_data
                payment.save()
                
                # Session'dan Ã¶deme bilgilerini al
                payment_data = request.session.get('payment_data', {})
                
                # Abonelik oluÅŸtur
                subscription, created = Subscription.objects.get_or_create(user=payment.user)
                subscription.plan = payment.package
                subscription.accepted_terms = payment_data.get('accepted_terms', False)
                subscription.accepted_sale = payment_data.get('accepted_sale', False)
                subscription.accepted_delivery = payment_data.get('accepted_delivery', False)
                subscription.start_date = timezone.now()
                subscription.tc_or_vergi_no = payment_data.get('tc_or_vergi_no', '')
                subscription.address = payment_data.get('address', '')
                subscription.end_date = None  # save() metodunda hesaplanacak
                subscription.save()
                
                # Bildirim sistemi ile Ã¶deme bildirimi oluÅŸtur
                from .notification_service import NotificationService
                
                package_names = {
                    'monthly': 'AylÄ±k Paket',
                    'quarterly': '3 AylÄ±k Paket', 
                    'semi_annual': '6 AylÄ±k Paket',
                    'annual': 'YÄ±llÄ±k Paket'
                }
                package_name = package_names.get(payment.package, payment.package)
                
                # KullanÄ±cÄ± ve admin bildirimleri oluÅŸtur
                NotificationService.create_purchase_notification(
                    user=payment.user,
                    payment=payment,
                    package_name=package_name
                )
                
                # Session'Ä± temizle
                if 'payment_data' in request.session:
                    del request.session['payment_data']
                
                return redirect('subscription_success')
                
            except Payment.DoesNotExist:
                return render(request, 'core/payment_error.html', {
                    'error': 'Ã–deme kaydÄ± bulunamadÄ±.'
                })
        else:
            return render(request, 'core/payment_error.html', {
                'error': verification_result.get('message', 'Ã–deme doÄŸrulamasÄ± baÅŸarÄ±sÄ±z.')
            })
            
    except Exception as e:
        return render(request, 'core/payment_error.html', {
            'error': f'Ã–deme iÅŸlemi sÄ±rasÄ±nda hata oluÅŸtu: {str(e)}'
        })


def demo_payment(request):
    """Demo Ã¶deme sayfasÄ± - IP adresi kayÄ±tlÄ± olmayan yerel test ortamÄ± iÃ§in"""
    order_id = request.GET.get('order_id')
    amount = request.GET.get('amount', '0')
    package = request.GET.get('package', 'monthly')
    
    param_service = ParamPaymentService()
    package_name = param_service.get_package_description(package)
    
    if request.method == 'POST':
        # Demo Ã¶deme "baÅŸarÄ±lÄ±" simÃ¼lasyonu
        action = request.POST.get('action')
        if action == 'success':
            return redirect(f'/payment/success/?order_id={order_id}&demo=1')
        else:
            return redirect(f'/payment/fail/?order_id={order_id}&demo=1')
    
    context = {
        'order_id': order_id,
        'amount': amount,
        'package': package,
        'package_name': package_name,
        'demo_mode': True,
        'ip_address': '145.223.82.130',
        'client_code': param_service.client_code
    }
    
    return render(request, 'core/demo_payment.html', context)

@csrf_exempt
def payment_3d_callback(request):
    """
    3D Secure callback handler
    Query param: ?durum=basarili veya ?durum=hata
    """
    durum = request.GET.get('durum')
    param_service = ParamSimpleService()
    
    if durum != 'basarili':
        # 3D doÄŸrulama baÅŸarÄ±sÄ±z
        return render(request, 'core/payment_error.html', {
            'error': '3D Secure doÄŸrulama baÅŸarÄ±sÄ±z oldu.'
        })
    
    try:
        # POST verilerini al
        callback_data = request.POST.dict()
        
        # 3D Ã¶demeyi tamamla
        payment_result = param_service.complete_3d_payment(request, callback_data)
        
        if payment_result['success']:
            # Session'dan Ã¶deme bilgilerini al
            payment_data = request.session.get('payment_data', {})
            order_id = payment_result.get('order_id') or payment_data.get('order_id')
            
            try:
                # Ã–deme kaydÄ±nÄ± gÃ¼ncelle
                payment = Payment.objects.get(order_id=order_id)
                payment.status = 'success'
                payment.transaction_id = payment_result.get('transaction_id')
                payment.param_response = callback_data
                payment.save()
                
                # Abonelik oluÅŸtur
                subscription, created = Subscription.objects.get_or_create(user=payment.user)
                subscription.plan = payment.package
                subscription.accepted_terms = payment_data.get('accepted_terms', False)
                subscription.accepted_sale = payment_data.get('accepted_sale', False)
                subscription.accepted_delivery = payment_data.get('accepted_delivery', False)
                subscription.start_date = timezone.now()
                subscription.tc_or_vergi_no = payment_data.get('tc_or_vergi_no', '')
                subscription.address = payment_data.get('address', '')
                subscription.end_date = None  # save() metodunda hesaplanacak
                subscription.save()
                
                # Bildirim oluÅŸtur
                from .notification_service import NotificationService
                
                package_names = {
                    'monthly': 'AylÄ±k Paket',
                    'quarterly': '3 AylÄ±k Paket', 
                    'semi_annual': '6 AylÄ±k Paket',
                    'annual': 'YÄ±llÄ±k Paket'
                }
                package_name = package_names.get(payment.package, payment.package)
                
                NotificationService.create_purchase_notification(
                    user=payment.user,
                    payment=payment,
                    package_name=package_name
                )
                
                # Session'Ä± temizle
                if 'payment_data' in request.session:
                    del request.session['payment_data']
                
                return redirect('subscription_success')
                
            except Payment.DoesNotExist:
                return render(request, 'core/payment_error.html', {
                    'error': 'Ã–deme kaydÄ± bulunamadÄ±.'
                })
        else:
            return render(request, 'core/payment_error.html', {
                'error': payment_result.get('error', 'Ã–deme tamamlanamadÄ±.')
            })
            
    except Exception as e:
        return render(request, 'core/payment_error.html', {
            'error': f'3D Ã¶deme iÅŸlemi sÄ±rasÄ±nda hata oluÅŸtu: {str(e)}'
        })

@csrf_exempt
def payment_fail(request):
    """
    Param Pos'dan gelen baÅŸarÄ±sÄ±z Ã¶deme callback'i
    """
    try:
        response_data = request.POST.dict()
        order_id = response_data.get('merchant_oid')
        
        if order_id:
            try:
                payment = Payment.objects.get(order_id=order_id)
                payment.status = 'failed'
                payment.error_message = response_data.get('message', 'Ã–deme baÅŸarÄ±sÄ±z')
                payment.param_response = response_data
                payment.save()
            except Payment.DoesNotExist:
                pass
        
        return render(request, 'core/payment_error.html', {
            'error': response_data.get('message', 'Ã–deme iÅŸlemi baÅŸarÄ±sÄ±z oldu.')
        })
        
    except Exception as e:
        return render(request, 'core/payment_error.html', {
            'error': f'Ã–deme iÅŸlemi sÄ±rasÄ±nda hata oluÅŸtu: {str(e)}'
        })


@login_required
def subscription_success(request):
    """
    BaÅŸarÄ±lÄ± Ã¶deme sonrasÄ± gÃ¶sterilecek sayfa
    """
    return render(request, 'core/subscription_success.html')

@login_required
@subscription_required
def some_protected_view(request):
    # Ä°Ã§erik
    return render(request, 'core/protected.html')

def ai_features_home(request):
    """
    AI Ã–zellikler ana sayfasÄ±
    """
    return render(request, 'core/ai_features.html')


# Footer'da yer alan yasal ve iletiÅŸim sayfalarÄ± iÃ§in statik view'lar:

def ziyaretci_veri_koruma(request):
    return render(request, "core/ziyaretci_veri_koruma.html")

def gizlilik_politikasi(request):
    """
    Gizlilik PolitikasÄ± / KiÅŸisel Verileri Koruma PolitikasÄ± sayfasÄ±.
    """
    return render(request, 'core/gizlilik_politikasi.html')

def kullanici_sozlesmesi(request):
    """
    KullanÄ±cÄ± SÃ¶zleÅŸmesi sayfasÄ±.
    """
    return render(request, 'core/kullanici_sozlesmesi.html')

def mesafeli_satis_sozlesmesi(request):
    """
    Mesafeli SatÄ±ÅŸ SÃ¶zleÅŸmesi sayfasÄ±.
    """
    return render(request, 'core/mesafeli_satis_sozlesmesi.html')

def teslimat_iade_sartlari(request):
    """
    Teslimat ve Ä°ade ÅartlarÄ± sayfasÄ±.
    """
    return render(request, 'core/teslimat_iade_sartlari.html')

def signup(request):
    if request.method == 'POST':
        form = CustomUserCreationForm(request.POST)
        if form.is_valid():
            user = form.save()
            login(request, user, backend='django.contrib.auth.backends.ModelBackend')  # Backend belirtildi
            return redirect('home')  # BaÅŸarÄ±lÄ± kayÄ±t sonrasÄ± ana sayfaya yÃ¶nlendir
    else:
        form = CustomUserCreationForm()
    return render(request, 'core/signup.html', {'form': form})

def register(request):
    if request.method == 'POST':
        form = CustomUserCreationForm(request.POST)
        if form.is_valid():
            user = form.save()
            # KullanÄ±cÄ± kaydÄ±nÄ± tamamladÄ±ktan sonra otomatik olarak giriÅŸ yapÄ±yoruz.
            login(request, user, backend='django.contrib.auth.backends.ModelBackend')
            return redirect('home')
    else:
        form = CustomUserCreationForm()
    return render(request, 'core/register.html', {'form': form})


def judicial_detail(request, pk):
    """
    Tek bir yargÄ± kararÄ±nÄ±n detaylarÄ±nÄ± gÃ¶sterir.
    """
    decision = get_object_or_404(JudicialDecision, pk=pk)
    context = {'decision': decision}
    return render(request, 'core/judicial_detail.html', context)

import json
from django.core.paginator import Paginator, EmptyPage, PageNotAnInteger
from django.shortcuts import render
from .models import Legislation

import json
from django.db.models import Q, Count
from django.core.paginator import Paginator, EmptyPage, PageNotAnInteger
from django.shortcuts import render
from .models import MevzuatGelismis, MevzuatMadde, MevzuatTuru, MevzuatKategori


def legislation_home(request):
    """
    Mevzuat ana sayfasÄ± - TÃ¼m mevzuat tÃ¼rlerini gÃ¶sterir
    """
    from django.db.models import Count, Q
    
    # Ä°statistikler
    active_filter = Q(durum='yurutulme')
    
    # Mevzuat tÃ¼rlerine gÃ¶re sayÄ±lar
    total_laws = MevzuatGelismis.objects.filter(
        active_filter,
        mevzuat_turu__kategori='kanun'
    ).count()
    
    total_regulations = MevzuatGelismis.objects.filter(
        active_filter,
        mevzuat_turu__kategori='yonetmelik'
    ).count()
    
    total_decrees = MevzuatGelismis.objects.filter(
        active_filter,
        mevzuat_turu__kategori__in=['cumhurbaskanligi_kararnamesi', 'bakanlar_kurulu_karari', 'cumhurbaskani_karari']
    ).count()
    
    total_others = MevzuatGelismis.objects.filter(
        active_filter
    ).exclude(
        mevzuat_turu__kategori__in=['kanun', 'yonetmelik', 'cumhurbaskanligi_kararnamesi', 'bakanlar_kurulu_karari', 'cumhurbaskani_karari']
    ).count()
    
    total_articles = MevzuatMadde.objects.count()
    
    # Mevzuat tÃ¼rleri ve sayÄ±larÄ±
    mevzuat_types = []
    for mtype in MevzuatTuru.objects.filter(aktif=True).order_by('sira'):
        count = MevzuatGelismis.objects.filter(
            active_filter,
            mevzuat_turu=mtype
        ).count()
        if count > 0:
            mevzuat_types.append({
                'id': mtype.id,
                'kod': mtype.kod,
                'ad': mtype.ad,
                'kategori': mtype.kategori,
                'count': count
            })
    
    # Son eklenen mevzuat (tÃ¼m tÃ¼rler)
    recent_mevzuat = MevzuatGelismis.objects.filter(
        active_filter
    ).select_related(
        'mevzuat_turu', 'kategori'
    ).prefetch_related(
        'maddeler'
    ).order_by('-kayit_tarihi')[:10]
    
    # PopÃ¼ler kategoriler
    popular_categories = MevzuatKategori.objects.filter(
        aktif=True
    ).annotate(
        mevzuat_count=Count('mevzuatgelismis', filter=Q(mevzuatgelismis__durum='yurutulme'))
    ).filter(
        mevzuat_count__gt=0
    ).order_by('-mevzuat_count')[:6]
    
    context = {
        'total_laws': total_laws,
        'total_regulations': total_regulations,
        'total_decrees': total_decrees,
        'total_others': total_others,
        'total_articles': total_articles,
        'mevzuat_types': mevzuat_types,
        'recent_mevzuat': recent_mevzuat,
        'popular_categories': popular_categories,
    }
    
    return render(request, 'core/legislation_home.html', context)

def mevzuat_pdf_view(request):
    """Mevzuat PDF gÃ¶rÃ¼ntÃ¼leyici - Parametrelerden PDF URL oluÅŸturur"""
    # Parametreleri al
    mevzuat_no = request.GET.get('no')
    mevzuat_tur = request.GET.get('tur')
    mevzuat_tertip = request.GET.get('tertip')
    title = request.GET.get('title', 'Mevzuat')
    
    # EÄŸer direkt URL verilmiÅŸse onu kullan
    direct_url = request.GET.get('url')
    if direct_url:
        context = {
            'pdf_url': direct_url,
            'title': title
        }
        return render(request, 'core/mevzuat_pdf_viewer.html', context)
    
    # Parametrelerden URL oluÅŸtur
    if not all([mevzuat_no, mevzuat_tur, mevzuat_tertip]):
        return JsonResponse({'error': 'Gerekli parametreler eksik (no, tur, tertip)'}, status=400)
    
    # PDF URL'sini oluÅŸtur
    pdf_url = f"https://www.mevzuat.gov.tr/MevzuatMetin/{mevzuat_tur}.{mevzuat_tertip}.{mevzuat_no}.pdf"
    
    context = {
        'pdf_url': pdf_url,
        'title': title,
        'mevzuat_no': mevzuat_no,
        'back_url': request.META.get('HTTP_REFERER', reverse('legislation_home'))
    }
    
    # mevzuat_pdf_viewer.html template'ini kullan
    return render(request, 'core/mevzuat_pdf_viewer.html', context)
def legislation_detail(request, mevzuat_id):
    """
    Mevzuat detay sayfasÄ±
    """
    from django.shortcuts import get_object_or_404
    from django.db.models import Count
    
    mevzuat = get_object_or_404(
        MevzuatGelismis.objects.select_related('mevzuat_turu', 'kategori'),
        id=mevzuat_id
    )
    
    # Maddeleri al (hiyerarÅŸik yapÄ± varsa Ã¼st maddeleri, yoksa tÃ¼mÃ¼nÃ¼)
    maddeler = mevzuat.maddeler.order_by('sira', 'madde_no')
    
    # EÄŸer hiÃ§ Ã¼st madde yoksa (dÃ¼z liste), tÃ¼mÃ¼nÃ¼ al
    if not mevzuat.maddeler.filter(ust_madde__isnull=False).exists():
        maddeler = mevzuat.maddeler.order_by('sira', 'madde_no')
    else:
        # HiyerarÅŸik yapÄ± varsa sadece Ã¼st maddeleri al
        maddeler = mevzuat.maddeler.filter(ust_madde__isnull=True).order_by('sira', 'madde_no')
    
    # Ä°lgili mevzuat
    ilgili_mevzuat = mevzuat.ilgili_mevzuatlar.filter(durum='yurutulme')[:5]
    
    # AynÄ± kategorideki diÄŸer mevzuat
    ayni_kategori = []
    if mevzuat.kategori:
        ayni_kategori = MevzuatGelismis.objects.filter(
            kategori=mevzuat.kategori,
            durum='yurutulme'
        ).exclude(id=mevzuat.id)[:5]
    
    # GÃ¶rÃ¼ntÃ¼lenme sayÄ±sÄ±nÄ± artÄ±r (eÄŸer alan varsa)
    if hasattr(mevzuat, 'goruntulenme'):
        mevzuat.goruntulenme += 1
        mevzuat.save(update_fields=['goruntulenme'])
    
    context = {
        'mevzuat': mevzuat,
        'maddeler': maddeler,
        'ilgili_mevzuat': ilgili_mevzuat,
        'ayni_kategori': ayni_kategori,
    }
    
    return render(request, 'core/legislation_detail.html', context)

def legislation_results(request):
    """
    Scrape edilmiÅŸ kanunlarda arama sonuÃ§larÄ±
    """
    from django.db.models import Q
    from django.core.paginator import Paginator
    
    query = request.GET.get('q', '').strip()
    mevzuat_type = request.GET.get('type', '').strip()
    category_code = request.GET.get('category', '').strip()
    
    # Ana filtre
    filters = Q(durum='yurutulme')
    
    # Arama sorgusu
    if query:
        filters &= (
            Q(baslik__icontains=query) |
            Q(mevzuat_numarasi__icontains=query) |
            Q(konu__icontains=query) |
            Q(anahtar_kelimeler__icontains=query) |
            Q(tam_metin__icontains=query) |
            Q(maddeler__metin__icontains=query)
        )
    
    # Mevzuat tÃ¼rÃ¼ filtresi
    if mevzuat_type:
        filters &= Q(mevzuat_turu__kategori=mevzuat_type)
    
    # Kategori filtresi
    if category_code:
        filters &= Q(kategori__kod=category_code)
    
    # VeritabanÄ±nda arama yap
    search_results = MevzuatGelismis.objects.filter(
        filters
    ).select_related(
        'mevzuat_turu', 'kategori'
    ).prefetch_related(
        'maddeler'
    ).distinct().order_by('-resmi_gazete_tarihi', '-kayit_tarihi')
    
    # Sayfalama
    paginator = Paginator(search_results, 20)
    page = request.GET.get('page')
    
    try:
        results = paginator.page(page)
    except PageNotAnInteger:
        results = paginator.page(1)
    except EmptyPage:
        results = paginator.page(paginator.num_pages)
    
    # Filtreler iÃ§in veriler
    available_types = MevzuatTuru.objects.filter(
        aktif=True,
        mevzuatgelismis__durum='yurutulme'
    ).distinct().order_by('sira')
    
    available_categories = MevzuatKategori.objects.filter(
        aktif=True,
        mevzuatgelismis__durum='yurutulme'
    ).distinct().order_by('ad')
    
    context = {
        'query': query,
        'mevzuat_type': mevzuat_type,
        'category_code': category_code,
        'results': results,
        'total_count': paginator.count,
        'available_types': available_types,
        'available_categories': available_categories,
        'page_range': paginator.get_elided_page_range(results.number, on_each_side=2, on_ends=1),
    }
    
    return render(request, 'core/legislation_results.html', context)


# ========================
# YENÄ° MEVZUAT ARAMA SÄ°STEMÄ° (MEVZUAT.GOV.TR ENTEGRASYONÄ°)
# ========================

def legislation_home_new(request):
    """
    Yeni mevzuat ana sayfasÄ± - mevzuat.gov.tr entegrasyonu ile
    """
    context = {
        'page_title': 'TÃ¼rk Hukuk MevzuatÄ± - Lexatech',
        'search_placeholder': 'Ã–rn: TÃ¼rk Medeni Kanunu, 4721 sayÄ±lÄ± kanun, miras hukuku...'
    }
    return render(request, 'core/legislation_home.html', context)

def legislation_search_new(request):
    """
    Mevzuat.gov.tr'de arama - Selenium ile sonuÃ§larÄ± Ã§ekip gÃ¶ster
    """
    from .improved_selenium_service import ImprovedSeleniumMevzuatService
    from urllib.parse import quote_plus
    import time
    
    query = request.GET.get('q', '').strip()
    page = int(request.GET.get('page', 1))
    
    if not query:
        return redirect('legislation_home')
    
    # Redirect modu (isteÄŸe baÄŸlÄ±)
    redirect_mode = request.GET.get('redirect', 'false').lower() == 'true'
    
    if redirect_mode:
        # DoÄŸrudan mevzuat.gov.tr'ye yÃ¶nlendir
        encoded_query = quote_plus(query)
        redirect_url = f"https://www.mevzuat.gov.tr/aramasonuc?AranacakMetin={encoded_query}"
        return redirect(redirect_url)
    
    try:
        # Selenium ile arama yap
        start_time = time.time()
        service = ImprovedSeleniumMevzuatService(headless=True)
        search_results = service.search_legislation(query, page)
        search_time = round(time.time() - start_time, 2)
        
        # SonuÃ§lar varsa gÃ¶ster
        if search_results.get('results'):
            # Sayfalama bilgilerini hazÄ±rla
            page_range = []
            total_pages = search_results.get('total_pages', 1)
            current_page = search_results.get('current_page', 1)
            
            # Basit sayfalama mantÄ±ÄŸÄ±
            start_page = max(1, current_page - 2)
            end_page = min(total_pages, current_page + 2)
            
            for i in range(start_page, end_page + 1):
                page_range.append(i)
            
            # BaÅŸlangÄ±Ã§ ve bitiÅŸ indekslerini hesapla
            per_page = 10
            start_index = (current_page - 1) * per_page + 1
            end_index = min(current_page * per_page, search_results.get('total_count', 0))
            
            context = {
                'query': query,
                'results': search_results.get('results', []),
                'total_count': search_results.get('total_count', 0),
                'has_next': search_results.get('has_next', False),
                'has_previous': search_results.get('has_previous', False),
                'current_page': current_page,
                'total_pages': total_pages,
                'page_range': page_range,
                'start_index': start_index,
                'end_index': end_index,
                'search_time': search_time,
                'error': search_results.get('error'),
                'iframe_mode': False,
                'show_post_form': False  # SonuÃ§ bulunduÄŸunda POST form gÃ¶sterme
            }
        else:
            # SonuÃ§ yoksa veya hata varsa boÅŸ sonuÃ§ gÃ¶ster
            context = {
                'query': query,
                'results': [],
                'total_count': 0,
                'has_next': False,
                'has_previous': False,
                'current_page': page,
                'total_pages': 1,
                'search_time': search_time,
                'error': search_results.get('error') or 'SonuÃ§ bulunamadÄ±',
                'iframe_mode': False,
                'show_post_form': False
            }
        
        return render(request, 'core/legislation_search_results.html', context)
        
    except Exception as e:
        logger.error(f"Mevzuat arama hatasÄ±: {e}")
        
        # Hata durumunda da boÅŸ sonuÃ§ gÃ¶ster
        context = {
            'query': query,
            'results': [],
            'total_count': 0,
            'error': f'Arama sÄ±rasÄ±nda bir hata oluÅŸtu: {str(e)}',
            'iframe_mode': False,
            'show_post_form': False
        }
        
        return render(request, 'core/legislation_search_results.html', context)
    """
    Mevzuat PDF gÃ¶rÃ¼ntÃ¼leyici
    """
    from .mevzuat_service import mevzuat_service
    
    # URL parametrelerini al
    mevzuat_no = request.GET.get('no')
    mevzuat_tur = request.GET.get('tur')
    mevzuat_tertip = request.GET.get('tertip')
    title = request.GET.get('title', 'Mevzuat')
    
    if not all([mevzuat_no, mevzuat_tur, mevzuat_tertip]):
        return render(request, 'core/error.html', {
            'error': 'GeÃ§ersiz mevzuat parametreleri'
        })
    
    try:
        # Mevzuat detaylarÄ±nÄ± al
        detail_info = mevzuat_service.get_mevzuat_detail(
            mevzuat_no, mevzuat_tur, mevzuat_tertip
        )
        
        if not detail_info or not detail_info.get('pdf_url'):
            # PDF URL'sini manuel oluÅŸtur
            pdf_url = f"https://www.mevzuat.gov.tr/MevzuatMetin/{mevzuat_tur}.{mevzuat_tertip}.{mevzuat_no}.pdf"
        else:
            pdf_url = detail_info['pdf_url']
        
        context = {
            'pdf_url': pdf_url,
            'title': title,
            'mevzuat_no': mevzuat_no,
            'word_url': detail_info.get('word_url') if detail_info else None,
            'resmi_gazete_info': detail_info.get('resmi_gazete_info') if detail_info else None,
            'back_url': request.META.get('HTTP_REFERER', reverse('legislation_home'))
        }
        
        return render(request, 'core/mevzuat_pdf_viewer.html', context)
        
    except Exception as e:
        logger.error(f"PDF gÃ¶rÃ¼ntÃ¼leme hatasÄ±: {e}")
        return render(request, 'core/error.html', {
            'error': 'PDF gÃ¶rÃ¼ntÃ¼lenirken bir hata oluÅŸtu'
        })

def mevzuat_search_page(request):
    """Public Mevzuat Search Page with Beautiful UI"""
    return render(request, 'core/mevzuat_search.html', {
        'page_title': 'Mevzuat Arama'
    })



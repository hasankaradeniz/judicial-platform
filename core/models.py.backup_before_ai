# core/models.py
from django.db import models
import io
import mammoth
import fitz
import re
from django.contrib.auth.models import User
from django.utils import timezone
from datetime import timedelta
from django.core.validators import MinLengthValidator, RegexValidator
from django.utils.timezone import now
from django.db.models.signals import post_save
from django.dispatch import receiver

class UserProfile(models.Model):
    """KullanÄ±cÄ± profil bilgileri iÃ§in ek model"""
    user = models.OneToOneField(User, on_delete=models.CASCADE, related_name='profile')
    phone_number = models.CharField(
        "Telefon NumarasÄ±", 
        max_length=15,
        validators=[
            RegexValidator(
                r'^[\+\d\s\-\(\)]+$', 
                "GeÃ§erli bir telefon numarasÄ± giriniz. (Ã–rn: 05551234567 veya +90 555 123 45 67)"
            )
        ],
        help_text="Telefon numaranÄ±zÄ± giriniz"
    )
    
    # Adres bilgileri - fatura iÃ§in gerekli
    address_line_1 = models.CharField(
        "Adres SatÄ±rÄ± 1", 
        max_length=255,
        blank=True,
        null=True,
        help_text="Mahalle, cadde, sokak ve kapÄ± numarasÄ±"
    )
    address_line_2 = models.CharField(
        "Adres SatÄ±rÄ± 2", 
        max_length=255,
        blank=True,
        null=True,
        help_text="Apartman, daire numarasÄ± gibi ek adres bilgileri (opsiyonel)"
    )
    city = models.CharField(
        "Åehir", 
        max_length=100,
        blank=True,
        null=True
    )
    district = models.CharField(
        "Ä°lÃ§e", 
        max_length=100,
        blank=True,
        null=True
    )
    postal_code = models.CharField(
        "Posta Kodu", 
        max_length=10,
        blank=True,
        null=True,
        validators=[
            RegexValidator(
                r'^\d{5}$', 
                "GeÃ§erli bir posta kodu giriniz. (Ã–rn: 34000)"
            )
        ]
    )
    
    is_free_trial = models.BooleanField("Ãœcretsiz Deneme", default=True)
    free_trial_start = models.DateTimeField("Ãœcretsiz Deneme BaÅŸlangÄ±Ã§", auto_now_add=True)
    free_trial_end = models.DateTimeField("Ãœcretsiz Deneme BitiÅŸ", null=True, blank=True)
    created_at = models.DateTimeField("OluÅŸturulma Tarihi", auto_now_add=True)
    updated_at = models.DateTimeField("GÃ¼ncellenme Tarihi", auto_now=True)
    
    class Meta:
        verbose_name = "KullanÄ±cÄ± Profili"
        verbose_name_plural = "KullanÄ±cÄ± Profilleri"
    
    def save(self, *args, **kwargs):
        # Ãœcretsiz deneme bitiÅŸ tarihini otomatik hesapla (2 ay = 60 gÃ¼n)
        if not self.free_trial_end and self.is_free_trial:
            if not self.free_trial_start:
                self.free_trial_start = timezone.now()
            self.free_trial_end = self.free_trial_start + timedelta(days=60)
        super().save(*args, **kwargs)
    
    def is_free_trial_expired(self):
        """Ãœcretsiz deneme sÃ¼resi dolmuÅŸ mu kontrol et"""
        if not self.is_free_trial:
            return False
        return timezone.now() > self.free_trial_end if self.free_trial_end else False
    
    def has_active_subscription(self):
        """Aktif aboneliÄŸi var mÄ± kontrol et"""
        try:
            subscription = self.user.subscription
            return subscription.end_date > timezone.now()
        except Subscription.DoesNotExist:
            return False
    
    def can_access_platform(self):
        """Platform eriÅŸimi var mÄ± kontrol et"""
        return (self.is_free_trial and not self.is_free_trial_expired()) or self.has_active_subscription()
    
    def get_remaining_trial_days(self):
        """Kalan deneme gÃ¼n sayÄ±sÄ±nÄ± dÃ¶ndÃ¼r"""
        if not self.is_free_trial or not self.free_trial_end:
            return 0
        remaining = (self.free_trial_end - timezone.now()).days
        return max(0, remaining)
    
    def is_trial_ending_soon(self):
        """Deneme sÃ¼resi 7 gÃ¼n iÃ§inde bitiyor mu"""
        return self.is_free_trial and self.get_remaining_trial_days() <= 7
    
    def __str__(self):
        return f"{self.user.username} - {self.phone_number}"

@receiver(post_save, sender=User)
def create_user_profile(sender, instance, created, **kwargs):
    """Yeni kullanÄ±cÄ± oluÅŸturulduÄŸunda otomatik profil oluÅŸtur"""
    if created:
        try:
            profile = UserProfile.objects.create(user=instance)
            # Ensure free trial dates are set (2 ay = 60 gÃ¼n)
            if not profile.free_trial_start:
                profile.free_trial_start = timezone.now()
            if not profile.free_trial_end:
                profile.free_trial_end = profile.free_trial_start + timedelta(days=60)
            profile.save()
        except Exception as e:
            print(f"Error creating user profile: {e}")

@receiver(post_save, sender=User)
def save_user_profile(sender, instance, **kwargs):
    """KullanÄ±cÄ± kaydedildiÄŸinde profili de kaydet"""
    try:
        if hasattr(instance, 'profile'):
            instance.profile.save()
    except Exception as e:
        print(f"Error saving user profile: {e}")

class JudicialDecision(models.Model):
    karar_turu = models.CharField("Karar TÃ¼rÃ¼", max_length=255)
    karar_veren_mahkeme = models.CharField("KararÄ± Veren Mahkeme", max_length=255)
    esas_numarasi = models.CharField("Esas NumarasÄ±", max_length=100, blank=True, null=True)
    karar_numarasi = models.CharField("Karar NumarasÄ±", max_length=100, blank=True, null=True)
    karar_tarihi = models.DateField("Karar Tarihi", blank=True, null=True)
    anahtar_kelimeler = models.TextField("Anahtar Kelimeler", blank=True, null=True)
    detected_legal_area = models.CharField("Tespit Edilen Hukuk AlanÄ±", max_length=50, blank=True, null=True, 
                                         help_text="Otomatik tespit edilen hukuk alanÄ±")
    
    def save(self, *args, **kwargs):
        # Anahtar kelime otomatik Ã¼retimi
        if not self.anahtar_kelimeler and self.karar_ozeti:
            self.anahtar_kelimeler = self.generate_keywords()
        super().save(*args, **kwargs)
    
    def generate_keywords(self):
        """Karar Ã¶zetinden otomatik anahtar kelime Ã¼retimi"""
        if not self.karar_ozeti:
            return ""
        
        # Basit anahtar kelime Ã§Ä±karÄ±mÄ±
        import re
        text = self.karar_ozeti.lower()
        
        # Hukuki terimler sÃ¶zlÃ¼ÄŸÃ¼
        legal_terms = {
            'miras': ['miras', 'tereke', 'vasiyet', 'muris'],
            'sÃ¶zleÅŸme': ['sÃ¶zleÅŸme', 'anlaÅŸma', 'mukavele'],
            'tazminat': ['tazminat', 'zarar', 'maddi zarar'],
            'borÃ§': ['borÃ§', 'yÃ¼kÃ¼mlÃ¼lÃ¼k', 'ifa'],
            'aile': ['boÅŸanma', 'nafaka', 'velayet'],
            'kira': ['kira', 'kiracÄ±', 'kiraya'],
            'iÅŸ': ['iÅŸÃ§i', 'iÅŸveren', 'iÅŸ sÃ¶zleÅŸmesi'],
            'mÃ¼lkiyet': ['mÃ¼lkiyet', 'tapu', 'gayrimenkul'],
            'dava': ['dava', 'davacÄ±', 'davalÄ±'],
            'iptal': ['iptal', 'fesih', 'geÃ§ersiz']
        }
        
        found_keywords = []
        
        # Hukuki terimler kontrolÃ¼
        for main_term, variants in legal_terms.items():
            for variant in variants:
                if variant in text:
                    found_keywords.append(main_term)
                    break
        
        # Karar tÃ¼rÃ¼ne gÃ¶re ek kelimeler
        if self.karar_turu:
            karar_turu_lower = self.karar_turu.lower()
            if 'miras' in karar_turu_lower:
                found_keywords.extend(['miras hukuku', 'tenkis', 'saklÄ± pay'])
            elif 'borÃ§' in karar_turu_lower:
                found_keywords.extend(['borÃ§lar hukuku', 'sÃ¶zleÅŸme'])
            elif 'aile' in karar_turu_lower:
                found_keywords.extend(['aile hukuku', 'evlilik'])
        
        # Mahkeme tÃ¼rÃ¼ne gÃ¶re ek kelimeler
        if self.karar_veren_mahkeme:
            mahkeme_lower = self.karar_veren_mahkeme.lower()
            if 'yargÄ±tay' in mahkeme_lower:
                found_keywords.append('yargÄ±tay kararÄ±')
            elif 'danÄ±ÅŸtay' in mahkeme_lower:
                found_keywords.append('idari yargÄ±')
        
        # SayÄ±larÄ± ve miktarlarÄ± bul
        amounts = re.findall(r'\d+\.?\d*\s*(?:tl|lira)', text)
        if amounts:
            found_keywords.append('maddi tazminat')
        
        # Tarihleri bul
        dates = re.findall(r'\d{1,2}[./]\d{1,2}[./]\d{4}', text)
        if dates:
            found_keywords.append('tarihli karar')
        
        # Benzersiz anahtar kelimeleri dÃ¶ndÃ¼r
        unique_keywords = list(set(found_keywords))
        return ', '.join(unique_keywords[:10])
    karar_ozeti = models.TextField("KararÄ±n Ã–zeti", blank=True, null=True)
    karar_tam_metni = models.TextField("KararÄ±n Tam Metni", blank=True, null=True)
    dosya = models.FileField("Dosya", upload_to='decisions/', blank=True, null=True)

    # Property methods for compatibility with new system
    @property
    def title(self):
        """Compatibility property for title"""
        return f"{self.karar_turu} - {self.karar_numarasi or ''}"
    
    @property
    def summary(self):
        """Compatibility property for summary"""
        return self.karar_ozeti
    
    @property
    def full_text(self):
        """Compatibility property for full text"""
        return self.karar_tam_metni
    
    @property
    def decision_date(self):
        """Compatibility property for decision date"""
        return self.karar_tarihi
    
    @property
    def court_name(self):
        """Compatibility property for court name"""
        return self.karar_veren_mahkeme

    def __str__(self):
        return f"{self.karar_veren_mahkeme} - {self.karar_numarasi}"

class Article(models.Model):
    makale_basligi = models.CharField("Makale BaÅŸlÄ±ÄŸÄ±", max_length=255, blank=True, null=True)
    dergi = models.CharField("YayÄ±nlandÄ±ÄŸÄ± Dergi", max_length=255, blank=True, null=True)
    yazarlar = models.CharField("Yazarlar", max_length=255, blank=True, null=True)
    makale_ozeti = models.TextField("Makale Ã–zeti", blank=True, null=True)
    makale_metni = models.TextField("Makale Metni", blank=True, null=True)
    dosya = models.FileField("Dosya", upload_to='articles/', blank=True, null=True)

    def save(self, *args, **kwargs):
        # EÄŸer dosya yÃ¼klendiyse ve makale_metni henÃ¼z boÅŸsa, dosyayÄ± iÅŸleyip alanlarÄ± dolduruyoruz.
        if self.dosya and not self.makale_metni:
            filename = self.dosya.name.lower()
            self.dosya.open('rb')
            file_content = self.dosya.read()
            self.dosya.seek(0)
            full_text = ""
            # DOCX dosyasÄ± iÃ§in Mammoth kullanÄ±mÄ±
            if filename.endswith('.docx'):
                file_io = io.BytesIO(file_content)
                result = mammoth.extract_raw_text(file_io)
                full_text = result.value
            # PDF dosyasÄ± iÃ§in PyMuPDF kullanÄ±mÄ±
            elif filename.endswith('.pdf'):
                try:
                    # PyMuPDF ile PDF iÃ§eriÄŸini oku
                    doc = fitz.open(stream=file_content, filetype="pdf")
                    text_list = []
                    for page in doc:
                        text_list.append(page.get_text())
                    full_text = "\n".join(text_list)
                except Exception as e:
                    full_text = ""
            # Ã‡Ä±kan metni makale_metni alanÄ±na atÄ±yoruz
            self.makale_metni = full_text

            # AÅŸaÄŸÄ±daki regex Ã¶rnekleri, dosyanÄ±n iÃ§inde "BaÅŸlÄ±k:", "Dergi:", "Yazarlar:" ve "Ã–zet:" gibi ifadeler bulunduÄŸunu varsayar.
            # Bu ifadeler dosya iÃ§eriÄŸine gÃ¶re uyarlanmalÄ±dÄ±r.
            title_match = re.search(r"BaÅŸlÄ±k\s*[:\-]\s*(.+)", full_text, re.IGNORECASE)
            if title_match:
                self.makale_basligi = title_match.group(1).strip()

            dergi_match = re.search(r"Dergi\s*[:\-]\s*(.+)", full_text, re.IGNORECASE)
            if dergi_match:
                self.dergi = dergi_match.group(1).strip()

            yazar_match = re.search(r"Yazarlar\s*[:\-]\s*(.+)", full_text, re.IGNORECASE)
            if yazar_match:
                self.yazarlar = yazar_match.group(1).strip()

            ozet_match = re.search(r"Ã–zet\s*[:\-]\s*(.+)", full_text, re.IGNORECASE | re.DOTALL)
            if ozet_match:
                self.makale_ozeti = ozet_match.group(1).strip()

        super().save(*args, **kwargs)

    def __str__(self):
        return self.makale_basligi or "Makale"


class Legislation(models.Model):
    MEVZUAT_TURLERI = [
        ('kanun', 'Kanun'),
        ('tuzuk', 'TÃ¼zÃ¼k'),
        ('yonetmelik', 'YÃ¶netmelik'),
        ('genelge', 'Genelge'),
        ('teblig', 'TebliÄŸ'),
        # DiÄŸer tÃ¼rler...
    ]
    mevzuat_turu = models.CharField("Mevzuat TÃ¼rÃ¼", max_length=50, choices=MEVZUAT_TURLERI)
    baslik = models.CharField("BaÅŸlÄ±k", max_length=255)
    mevzuat_numarasi = models.CharField("Mevzuat NumarasÄ±", max_length=100, blank=True, null=True)
    yayin_tarihi = models.DateField("YayÄ±n Tarihi", blank=True, null=True)
    yurutulme_tarihi = models.DateField("YÃ¼rÃ¼rlÃ¼k Tarihi", blank=True, null=True)
    resmigazete_tarihi = models.DateField("Resmi Gazete Tarihi", blank=True, null=True)
    konu = models.CharField("Konu", max_length=255, blank=True, null=True)
    ozet = models.TextField("Ã–zet", blank=True, null=True)
    tam_metin = models.TextField("Tam Metin", blank=True, null=True)
    dosya = models.FileField("Dosya", upload_to='legislation/', blank=True, null=True)
    tam_metin_html = models.TextField("Tam Metin (HTML)", blank=True, null=True)

    def save(self, *args, **kwargs):
        # DÃ¶nÃ¼ÅŸtÃ¼rme iÅŸlemi yalnÄ±zca dosya yeni yÃ¼klendiyse ve tam_metin_html boÅŸsa yapÄ±lÄ±r.
        if self.dosya and not self.tam_metin_html:
            filename = self.dosya.name.lower()
            # DOCX dosyalarÄ± iÃ§in Mammoth kullanÄ±mÄ±:
            if filename.endswith('.docx'):
                self.dosya.open('rb')
                file_content = self.dosya.read()
                file_io = io.BytesIO(file_content)
                result = mammoth.convert_to_html(file_io)
                self.tam_metin_html = result.value
                self.dosya.seek(0)
            # PDF dosyalarÄ± iÃ§in PyMuPDF kullanÄ±mÄ±:
            elif filename.endswith('.pdf'):
                self.dosya.open('rb')
                file_content = self.dosya.read()
                try:
                    # BytesIO'dan direkt dosya iÃ§eriÄŸini kullanarak aÃ§Ä±yoruz.
                    doc = fitz.open(stream=file_content, filetype="pdf")
                    html_pages = []
                    for page in doc:
                        # Yeni API: get_text("html") kullanÄ±yoruz.
                        page_html = page.get_text("html")
                        html_pages.append(page_html)
                    self.tam_metin_html = "\n".join(html_pages)
                except Exception as e:
                    # Hata durumunda istisna mesajÄ±nÄ± loglayabilir, burada basitÃ§e mesaj gÃ¶steriyoruz.
                    self.tam_metin_html = "<p>PDF iÃ§eriÄŸi dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lemedi: {}</p>".format(e)
                finally:
                    self.dosya.seek(0)
        super().save(*args, **kwargs)

    def __str__(self):
        return self.baslik

# ========================
# GENÄ°ÅLETÄ°LMÄ°Å MEVZUAT SÄ°STEMÄ°
# ========================

class MevzuatTuru(models.Model):
    """GeliÅŸmiÅŸ mevzuat tÃ¼rÃ¼ yÃ¶netimi"""
    KATEGORI_CHOICES = [
        ('kanun', 'Kanunlar'),
        ('cumhurbaskanligi_kararnamesi', 'CumhurbaÅŸkanlÄ±ÄŸÄ± Kararnameleri'),
        ('bakanlar_kurulu_karari', 'Bakanlar Kurulu KararlarÄ±'),
        ('cumhurbaskani_karari', 'CumhurbaÅŸkanÄ± KararlarÄ±'),
        ('yonetmelik', 'YÃ¶netmelikler'),
        ('tuzuk', 'TÃ¼zÃ¼kler'),
        ('teblig', 'TebliÄŸler'),
        ('genelge', 'Genelgeler'),
        ('mÃ¼lga', 'MÃ¼lga Mevzuat'),
        ('uluslararasi_andlasma', 'UluslararasÄ± AndlaÅŸmalar'),
    ]
    
    kod = models.CharField("TÃ¼r Kodu", max_length=50, unique=True)
    ad = models.CharField("TÃ¼r AdÄ±", max_length=100)
    kategori = models.CharField("Kategori", max_length=50, choices=KATEGORI_CHOICES)
    aciklama = models.TextField("AÃ§Ä±klama", blank=True, null=True)
    aktif = models.BooleanField("Aktif", default=True)
    sira = models.IntegerField("SÄ±ra", default=0)
    
    class Meta:
        verbose_name = "Mevzuat TÃ¼rÃ¼"
        verbose_name_plural = "Mevzuat TÃ¼rleri"
        ordering = ['sira', 'ad']
    
    def __str__(self):
        return self.ad

class MevzuatKategori(models.Model):
    """Mevzuat konularÄ±na gÃ¶re kategoriler"""
    ad = models.CharField("Kategori AdÄ±", max_length=100)
    kod = models.CharField("Kategori Kodu", max_length=20, unique=True)
    aciklama = models.TextField("AÃ§Ä±klama", blank=True, null=True)
    ust_kategori = models.ForeignKey('self', on_delete=models.CASCADE, 
                                    blank=True, null=True, 
                                    verbose_name="Ãœst Kategori")
    aktif = models.BooleanField("Aktif", default=True)
    
    class Meta:
        verbose_name = "Mevzuat Kategorisi"
        verbose_name_plural = "Mevzuat Kategorileri"
        ordering = ['ad']
    
    def __str__(self):
        return self.ad

class MevzuatGelismis(models.Model):
    """GeliÅŸtirilmiÅŸ mevzuat modeli"""
    
    # Temel Bilgiler
    baslik = models.CharField("BaÅŸlÄ±k", max_length=500)
    mevzuat_turu = models.ForeignKey(MevzuatTuru, on_delete=models.PROTECT, 
                                    verbose_name="Mevzuat TÃ¼rÃ¼")
    kategori = models.ForeignKey(MevzuatKategori, on_delete=models.SET_NULL, 
                                blank=True, null=True, verbose_name="Kategori")
    
    # NumaralandÄ±rma
    mevzuat_numarasi = models.CharField("Mevzuat NumarasÄ±", max_length=100, 
                                       blank=True, null=True)
    sira_numarasi = models.CharField("SÄ±ra NumarasÄ±", max_length=50, 
                                    blank=True, null=True)
    
    # Tarihler
    yayin_tarihi = models.DateField("YayÄ±n Tarihi", blank=True, null=True)
    yurutulme_tarihi = models.DateField("YÃ¼rÃ¼rlÃ¼k Tarihi", blank=True, null=True)
    yurutulme_bitis_tarihi = models.DateField("YÃ¼rÃ¼rlÃ¼k BitiÅŸ Tarihi", 
                                             blank=True, null=True)
    
    # Resmi Gazete Bilgileri
    resmi_gazete_tarihi = models.DateField("Resmi Gazete Tarihi", 
                                          blank=True, null=True)
    resmi_gazete_sayisi = models.CharField("Resmi Gazete SayÄ±sÄ±", max_length=20, 
                                          blank=True, null=True)
    mukerrer_sayisi = models.CharField("MÃ¼kerrer SayÄ±sÄ±", max_length=10, 
                                      blank=True, null=True)
    
    # Ä°Ã§erik
    konu = models.TextField("Konu", blank=True, null=True)
    ozet = models.TextField("Ã–zet", blank=True, null=True)
    anahtar_kelimeler = models.TextField("Anahtar Kelimeler", blank=True, null=True)
    
    # Metinler
    tam_metin = models.TextField("Tam Metin", blank=True, null=True)
    tam_metin_html = models.TextField("Tam Metin (HTML)", blank=True, null=True)
    
    # Ä°liÅŸkiler
    ilgili_mevzuatlar = models.ManyToManyField('self', blank=True, 
                                              verbose_name="Ä°lgili Mevzuatlar")
    
    # Durum Bilgileri
    DURUM_CHOICES = [
        ('yurutulme', 'YÃ¼rÃ¼rlÃ¼kte'),
        ('ilga', 'Ä°lga Edildi'),
        ('degisiklik', 'DeÄŸiÅŸiklik YapÄ±ldÄ±'),
        ('mulga', 'MÃ¼lga'),
        ('geÃ§ici', 'GeÃ§ici'),
    ]
    durum = models.CharField("Durum", max_length=20, choices=DURUM_CHOICES, 
                            default='yurutulme')
    
    # Dosyalar
    dosya = models.FileField("Dosya", upload_to='mevzuat_gelismis/', 
                            blank=True, null=True)
    
    # Sistem AlanlarÄ±
    kayit_tarihi = models.DateTimeField("KayÄ±t Tarihi", auto_now_add=True)
    guncelleme_tarihi = models.DateTimeField("GÃ¼ncelleme Tarihi", auto_now=True)
    son_kontrol_tarihi = models.DateTimeField("Son Kontrol Tarihi", 
                                             blank=True, null=True)
    
    # Kaynak bilgisi
    kaynak_url = models.URLField("Kaynak URL", blank=True, null=True)
    mevzuat_gov_tr_id = models.CharField("Mevzuat.gov.tr ID", max_length=50, 
                                        blank=True, null=True, unique=True)
    
    class Meta:
        verbose_name = "GeliÅŸmiÅŸ Mevzuat"
        verbose_name_plural = "GeliÅŸmiÅŸ Mevzuatlar"
        ordering = ['-yayin_tarihi', '-id']
        indexes = [
            models.Index(fields=['mevzuat_turu', 'durum']),
            models.Index(fields=['yayin_tarihi']),
            models.Index(fields=['resmi_gazete_tarihi']),
            models.Index(fields=['mevzuat_gov_tr_id']),
        ]
    
    def __str__(self):
        return f"{self.baslik} ({self.mevzuat_numarasi or 'No: Yok'})"

class MevzuatMadde(models.Model):
    """Mevzuat maddelerini yÃ¶netim"""
    mevzuat = models.ForeignKey(MevzuatGelismis, on_delete=models.CASCADE, 
                               related_name='maddeler', verbose_name="Mevzuat")
    
    # Madde Bilgileri
    madde_no = models.CharField("Madde No", max_length=20)
    madde_basligi = models.CharField("Madde BaÅŸlÄ±ÄŸÄ±", max_length=200, 
                                    blank=True, null=True)
    
    # HiyerarÅŸi
    ust_madde = models.ForeignKey('self', on_delete=models.CASCADE, 
                                 blank=True, null=True, 
                                 verbose_name="Ãœst Madde")
    bent_no = models.CharField("Bent No", max_length=10, blank=True, null=True)
    fÄ±kra_no = models.CharField("FÄ±kra No", max_length=10, blank=True, null=True)
    
    # Ä°Ã§erik
    metin = models.TextField("Madde Metni")
    metin_html = models.TextField("Madde Metni (HTML)", blank=True, null=True)
    
    # Durum
    aktif = models.BooleanField("Aktif", default=True)
    sira = models.IntegerField("SÄ±ra", default=0)
    
    # Sistem
    kayit_tarihi = models.DateTimeField("KayÄ±t Tarihi", auto_now_add=True)
    guncelleme_tarihi = models.DateTimeField("GÃ¼ncelleme Tarihi", auto_now=True)
    
    class Meta:
        verbose_name = "Mevzuat Maddesi"
        verbose_name_plural = "Mevzuat Maddeleri"
        ordering = ['sira', 'madde_no']
        unique_together = ['mevzuat', 'madde_no', 'bent_no', 'fÄ±kra_no']
    
    def __str__(self):
        parts = [f"Madde {self.madde_no}"]
        if self.bent_no:
            parts.append(f"Bent {self.bent_no}")
        if self.fÄ±kra_no:
            parts.append(f"FÄ±kra {self.fÄ±kra_no}")
        return " - ".join(parts)

class MevzuatDegisiklik(models.Model):
    """Mevzuat deÄŸiÅŸiklik geÃ§miÅŸi"""
    mevzuat = models.ForeignKey(MevzuatGelismis, on_delete=models.CASCADE, 
                               related_name='degisiklikler', 
                               verbose_name="Mevzuat")
    
    # DeÄŸiÅŸiklik Bilgileri
    DEGISIKLIK_TURU = [
        ('ekleme', 'Madde Ekleme'),
        ('silme', 'Madde Silme'),
        ('degistirme', 'Madde DeÄŸiÅŸtirme'),
        ('yeniden_duzenleme', 'Yeniden DÃ¼zenleme'),
        ('ilga', 'Ä°lga'),
    ]
    
    degisiklik_turu = models.CharField("DeÄŸiÅŸiklik TÃ¼rÃ¼", max_length=20, 
                                      choices=DEGISIKLIK_TURU)
    aciklama = models.TextField("AÃ§Ä±klama")
    
    # DeÄŸiÅŸtiren Mevzuat
    degistiren_mevzuat = models.ForeignKey(MevzuatGelismis, 
                                          on_delete=models.CASCADE, 
                                          related_name='degistirdikleri',
                                          verbose_name="DeÄŸiÅŸtiren Mevzuat")
    
    # Etkilenen Maddeler
    etkilenen_maddeler = models.ManyToManyField(MevzuatMadde, blank=True,
                                               verbose_name="Etkilenen Maddeler")
    
    # Tarihler
    degisiklik_tarihi = models.DateField("DeÄŸiÅŸiklik Tarihi")
    yurutulme_tarihi = models.DateField("YÃ¼rÃ¼rlÃ¼k Tarihi")
    
    # Sistem
    kayit_tarihi = models.DateTimeField("KayÄ±t Tarihi", auto_now_add=True)
    
    class Meta:
        verbose_name = "Mevzuat DeÄŸiÅŸikliÄŸi"
        verbose_name_plural = "Mevzuat DeÄŸiÅŸiklikleri"
        ordering = ['-degisiklik_tarihi']
    
    def __str__(self):
        return f"{self.mevzuat.baslik} - {self.get_degisiklik_turu_display()}"

class MevzuatLog(models.Model):
    """Sistem log kayÄ±tlarÄ±"""
    ISLEM_TURU = [
        ('ekleme', 'Ekleme'),
        ('guncelleme', 'GÃ¼ncelleme'),
        ('silme', 'Silme'),
        ('scraping', 'Veri Ã‡ekme'),
        ('hata', 'Hata'),
    ]
    
    islem_turu = models.CharField("Ä°ÅŸlem TÃ¼rÃ¼", max_length=20, choices=ISLEM_TURU)
    aciklama = models.TextField("AÃ§Ä±klama")
    mevzuat = models.ForeignKey(MevzuatGelismis, on_delete=models.SET_NULL, 
                               blank=True, null=True, verbose_name="Ä°lgili Mevzuat")
    kullanici = models.ForeignKey(User, on_delete=models.SET_NULL, 
                                 blank=True, null=True, verbose_name="KullanÄ±cÄ±")
    ip_adresi = models.GenericIPAddressField("IP Adresi", blank=True, null=True)
    detaylar = models.JSONField("Detaylar", blank=True, null=True)
    
    # Sistem
    kayit_tarihi = models.DateTimeField("KayÄ±t Tarihi", auto_now_add=True)
    
    class Meta:
        verbose_name = "Mevzuat Log"
        verbose_name_plural = "Mevzuat LoglarÄ±"
        ordering = ['-kayit_tarihi']
    
    def __str__(self):
        return f"{self.get_islem_turu_display()} - {self.kayit_tarihi}"

class Subscription(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    plan = models.CharField(max_length=20, choices=[
        ('monthly', 'AylÄ±k'),
        ('quarterly', '3 AylÄ±k'),
        ('semi_annually', '6 AylÄ±k'),
        ('yearly', 'YÄ±llÄ±k')
    ])
    start_date = models.DateTimeField(default=now)
    end_date = models.DateTimeField(null=True, blank=True)

    # Yeni eklenen alanlar (null=True ve blank=True eklendi)
    tc_or_vergi_no = models.CharField(
        max_length=11,
        validators=[
            MinLengthValidator(10, "T.C. Kimlik veya Vergi NumarasÄ± en az 10 karakter olmalÄ±dÄ±r."),
            RegexValidator(r'^\d+$', "Sadece rakam giriniz.")
        ],
        verbose_name="T.C. Kimlik / Vergi NumarasÄ±",
        null=True, blank=True  # Mevcut veriler iÃ§in hata almamak adÄ±na eklendi
    )
    address = models.TextField(verbose_name="Adres", null=True, blank=True)  # GÃ¼ncellendi

    # KullanÄ±cÄ±nÄ±n satÄ±n alÄ±rken kabul ettiÄŸi sÃ¶zleÅŸmeler
    accepted_terms = models.BooleanField(default=False, verbose_name="KullanÄ±cÄ± SÃ¶zleÅŸmesi")
    accepted_sale = models.BooleanField(default=False, verbose_name="Mesafeli SatÄ±ÅŸ SÃ¶zleÅŸmesi")
    accepted_delivery = models.BooleanField(default=False, verbose_name="Teslimat & Ä°ade ÅartlarÄ±")


    def save(self, *args, **kwargs):
        # EÄŸer end_date henÃ¼z belirlenmemiÅŸse, plan tipine gÃ¶re hesaplanÄ±r.
        if not self.end_date:
            if self.plan == 'monthly':
                self.end_date = self.start_date + timedelta(days=30)
            elif self.plan == 'quarterly':
                self.end_date = self.start_date + timedelta(days=90)
            elif self.plan == 'half_yearly':
                self.end_date = self.start_date + timedelta(days=180)
            elif self.plan == 'yearly':
                self.end_date = self.start_date + timedelta(days=365)
        super().save(*args, **kwargs)

    def __str__(self):
        return f"{self.user.username} - {self.get_plan_display()}"


class Payment(models.Model):
    """Ã–deme iÅŸlemleri iÃ§in model"""
    PAYMENT_STATUS_CHOICES = [
        ('pending', 'Beklemede'),
        ('success', 'BaÅŸarÄ±lÄ±'),
        ('failed', 'BaÅŸarÄ±sÄ±z'),
        ('cancelled', 'Ä°ptal Edildi'),
    ]
    
    user = models.ForeignKey(User, on_delete=models.CASCADE, verbose_name="KullanÄ±cÄ±")
    package = models.CharField(max_length=20, verbose_name="Paket")
    amount = models.DecimalField(max_digits=10, decimal_places=2, verbose_name="Tutar")
    currency = models.CharField(max_length=3, default='TRY', verbose_name="Para Birimi")
    order_id = models.CharField(max_length=100, unique=True, verbose_name="SipariÅŸ No")
    transaction_id = models.CharField(max_length=100, blank=True, null=True, verbose_name="Ä°ÅŸlem No")
    status = models.CharField(max_length=20, choices=PAYMENT_STATUS_CHOICES, default='pending', verbose_name="Durum")
    payment_method = models.CharField(max_length=50, default='param_pos', verbose_name="Ã–deme YÃ¶ntemi")
    created_at = models.DateTimeField(auto_now_add=True, verbose_name="OluÅŸturulma Tarihi")
    updated_at = models.DateTimeField(auto_now=True, verbose_name="GÃ¼ncellenme Tarihi")
    error_message = models.TextField(blank=True, null=True, verbose_name="Hata MesajÄ±")
    
    # Param Pos spesifik alanlar
    param_hash = models.CharField(max_length=200, blank=True, null=True, verbose_name="Param Hash")
    param_response = models.JSONField(blank=True, null=True, verbose_name="Param YanÄ±tÄ±")
    
    class Meta:
        verbose_name = "Ã–deme"
        verbose_name_plural = "Ã–demeler"
        ordering = ['-created_at']
    
    def __str__(self):
        return f"{self.user.username} - {self.order_id} - {self.get_status_display()}"

class Notification(models.Model):
    """Bildirim sistemi"""
    NOTIFICATION_TYPES = [
        ('purchase', 'Paket SatÄ±n Alma'),
        ('expiry_warning', 'SÃ¼re Dolma UyarÄ±sÄ±'),
        ('expiry', 'SÃ¼re Doldu'),
        ('free_trial_warning', 'Ãœcretsiz Deneme Bitiyor'),
        ('free_trial_expired', 'Ãœcretsiz Deneme Bitti'),
        ('system', 'Sistem Bildirimi'),
    ]
    
    notification_type = models.CharField("Bildirim TÃ¼rÃ¼", max_length=20, choices=NOTIFICATION_TYPES)
    title = models.CharField("BaÅŸlÄ±k", max_length=200)
    message = models.TextField("Mesaj")
    
    # Ä°lgili kullanÄ±cÄ± (boÅŸsa admin bildirimi)
    user = models.ForeignKey(User, on_delete=models.CASCADE, blank=True, null=True, verbose_name="KullanÄ±cÄ±")
    
    # Ä°lgili payment/subscription
    payment = models.ForeignKey(Payment, on_delete=models.SET_NULL, blank=True, null=True, verbose_name="Ä°lgili Ã–deme")
    subscription = models.ForeignKey(Subscription, on_delete=models.SET_NULL, blank=True, null=True, verbose_name="Ä°lgili Abonelik")
    
    # Bildirim durumu
    is_read = models.BooleanField("Okundu", default=False)
    is_sent_email = models.BooleanField("E-posta GÃ¶nderildi", default=False)
    is_admin_notification = models.BooleanField("Admin Bildirimi", default=False)
    
    # Tarihler
    created_at = models.DateTimeField("OluÅŸturulma Tarihi", auto_now_add=True)
    sent_at = models.DateTimeField("GÃ¶nderilme Tarihi", blank=True, null=True)
    read_at = models.DateTimeField("Okunma Tarihi", blank=True, null=True)
    
    # Extra data
    extra_data = models.JSONField("Ek Veriler", blank=True, null=True)
    
    class Meta:
        verbose_name = "Bildirim"
        verbose_name_plural = "Bildirimler"
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['user', 'is_read']),
            models.Index(fields=['notification_type']),
            models.Index(fields=['is_admin_notification']),
        ]
    
    def mark_as_read(self):
        """Bildirimi okundu olarak iÅŸaretle"""
        if not self.is_read:
            self.is_read = True
            self.read_at = timezone.now()
            self.save()
    
    def send_email_notification(self):
        """E-posta bildirimi gÃ¶nder"""
        if not self.is_sent_email and self.user and self.user.email:
            from django.core.mail import send_mail
            from django.conf import settings
            
            try:
                send_mail(
                    subject=f"Lexatech - {self.title}",
                    message=self.message,
                    from_email=settings.DEFAULT_FROM_EMAIL,
                    recipient_list=[self.user.email],
                    fail_silently=False,
                )
                self.is_sent_email = True
                self.sent_at = timezone.now()
                self.save()
                return True
            except Exception as e:
                print(f"E-posta gÃ¶nderme hatasÄ±: {str(e)}")
                return False
        return False
    
    def __str__(self):
        user_info = f"{self.user.username}" if self.user else "Admin"
        return f"{user_info} - {self.title}"
# =========================
# GUNLUK RESMI GAZETE EMAIL SISTEMI
# =========================

class DailyGazetteContent(models.Model):
    """Gunluk Resmi Gazete icerikleri"""
    CONTENT_TYPES = [
        ("yurutme_idare", "Yurutme ve Idare"),
        ("anayasa_mahkemesi", "Anayasa Mahkemesi"),
        ("yargitay", "Yargitay"),
        ("danistay", "Danistay"),
        ("ilan", "Ilan"),
        ("duyuru", "Duyuru"),
        ("other", "Diger"),
    ]
    
    CATEGORIES = [
        ("atama_karari", "Atama Karari"),
        ("yonetmelik", "Yonetmelik"),
        ("teblig", "Teblig"),
        ("genelge", "Genelge"),
        ("cumhurbaskani_karari", "Cumhurbaskani Karari"),
        ("bakanlar_kurulu_karari", "Bakanlar Kurulu Karari"),
        ("kurul_karari", "Kurul Karari"),
        ("mahkeme_karari", "Mahkeme Karari"),
        ("ilan", "Ilan"),
        ("other", "Diger"),
    ]
    
    # Temel Bilgiler
    title = models.CharField("Baslik", max_length=500)
    content_type = models.CharField("Icerik Turu", max_length=50, choices=CONTENT_TYPES)
    category = models.CharField("Kategori", max_length=50, choices=CATEGORIES)
    
    # Resmi Gazete Bilgileri
    gazette_date = models.DateField("Resmi Gazete Tarihi")
    gazette_number = models.CharField("Resmi Gazete Sayisi", max_length=20, blank=True, null=True)
    original_url = models.URLField("Orijinal Link", max_length=500)
    
    # Icerik
    summary = models.TextField("Ozet", help_text="Email de gosterilecek kisa aciklama")
    full_content = models.TextField("Tam Icerik", blank=True, null=True)
    
    # AI Analizi (gelecekte eklenebilir)
    ai_analysis = models.TextField("AI Analizi", blank=True, null=True)
    affected_sectors = models.JSONField("Etkilenen Sektorler", blank=True, null=True)
    importance_score = models.IntegerField("Onem Skoru", default=5, help_text="1-10 arasi")
    
    # Sistem Bilgileri
    created_at = models.DateTimeField("Olusturulma Tarihi", auto_now_add=True)
    updated_at = models.DateTimeField("Guncelleme Tarihi", auto_now=True)
    is_active = models.BooleanField("Aktif", default=True)
    scraping_source = models.CharField("Kaynak", max_length=100, default="resmigazete.gov.tr")
    
    # Email e dahil edildi mi?
    is_included_in_email = models.BooleanField("Email e Dahil", default=True)
    email_priority = models.IntegerField("Email Onceligi", default=5, help_text="1=En Onemli, 10=Az Onemli")
    
    class Meta:
        verbose_name = "Gunluk Gazete Icerigi"
        verbose_name_plural = "Gunluk Gazete Icerikleri"
        ordering = ["-gazette_date", "-importance_score", "email_priority"]
        indexes = [
            models.Index(fields=["gazette_date", "is_active"]),
            models.Index(fields=["content_type", "category"]),
            models.Index(fields=["is_included_in_email"]),
        ]
        unique_together = ["title", "gazette_date"]
    
    def __str__(self):
        return f"{self.gazette_date.strftime('%d.%m.%Y')} - {self.get_category_display()} - {self.title[:50]}..."

    def get_enhanced_category_display(self):
        """GeliÅŸtirilmiÅŸ kategori gÃ¶rÃ¼ntÃ¼leme"""
        category_mapping = {
            "atama_karari": "ğŸ‘¥ Atama KararÄ±",
            "yonetmelik": "ğŸ“‹ YÃ¶netmelik",
            "teblig": "ğŸ“¢ TebliÄŸ",
            "genelge": "ğŸ“„ Genelge",
            "cumhurbaskani_karari": "âš–ï¸ CumhurbaÅŸkanÄ± KararÄ±",
            "bakanlar_kurulu_karari": "ğŸ›ï¸ Bakanlar Kurulu KararÄ±",
            "kurul_karari": "ğŸ¢ Kurul KararÄ±",
            "mahkeme_karari": "âš–ï¸ Mahkeme KararÄ±",
            "ilan": "ğŸ“£ Ä°lan",
            "gunluk_sayi": "ğŸ“° GÃ¼nlÃ¼k SayÄ±",
            "other": "ğŸ“„ Ä°dari Ä°ÅŸlem"
        }
        return category_mapping.get(self.category, self.get_category_display())

    def get_enhanced_summary(self):
        """Ä°Ã§eriÄŸe gÃ¶re geliÅŸtirilmiÅŸ Ã¶zet"""
        title_lower = self.title.lower()
        category = self.category

        if category == "cumhurbaskani_karari":
            if "vekalet" in title_lower:
                return "CumhurbaÅŸkanlÄ±ÄŸÄ±na vekalet etme yetkisi ile ilgili dÃ¼zenleme yapÄ±lmÄ±ÅŸtÄ±r. Bu karar, devlet yÃ¶netiminin devamlÄ±lÄ±ÄŸÄ±nÄ± saÄŸlamaya yÃ¶nelik Ã¶nemli bir idari iÅŸlemdir."
            elif "atama" in title_lower:
                return "CumhurbaÅŸkanÄ± tarafÄ±ndan kamu gÃ¶revlilerinin atanmasÄ± ile ilgili karar alÄ±nmÄ±ÅŸtÄ±r. Bu dÃ¼zenleme, kamu yÃ¶netimindeki personel deÄŸiÅŸikliklerini kapsamaktadÄ±r."
            elif "enerji" in title_lower or "elektrik" in title_lower:
                return "Enerji sektÃ¶rÃ¼ ile ilgili CumhurbaÅŸkanÄ± kararÄ± yayÄ±mlanmÄ±ÅŸtÄ±r. Bu dÃ¼zenleme, enerji altyapÄ±sÄ± ve yatÄ±rÄ±mlarÄ± konusunda Ã¶nemli geliÅŸmeleri iÃ§ermektedir."
            elif "vergi" in title_lower:
                return "Vergi dÃ¼zenlemeleri kapsamÄ±nda CumhurbaÅŸkanÄ± kararÄ± Ã§Ä±karÄ±lmÄ±ÅŸtÄ±r. Bu karar, vergi politikalarÄ± ve uygulamalarÄ± aÃ§Ä±sÄ±ndan Ã¶nem taÅŸÄ±maktadÄ±r."
            else:
                return "CumhurbaÅŸkanÄ± tarafÄ±ndan Ã§Ä±karÄ±lan bu karar, kamu yÃ¶netimi ve dÃ¼zenleyici iÅŸlemler kapsamÄ±nda Ã¶nemli deÄŸiÅŸiklikler iÃ§ermektedir."
        elif category == "yonetmelik":
            return "Yeni yÃ¶netmelik dÃ¼zenlemesi ile ilgili kurallar ve uygulamalar gÃ¼ncellenmiÅŸtir. Bu dÃ¼zenleme, ilgili sektÃ¶r ve kurumlarda uygulanacak prosedÃ¼rleri belirlemektedir."
        elif category == "teblig":
            return "Ä°lgili kurum tarafÄ±ndan yayÄ±mlanan tebliÄŸ ile uygulamaya yÃ¶nelik aÃ§Ä±klamalar ve yÃ¶nlendirmeler yapÄ±lmÄ±ÅŸtÄ±r."
        elif category == "atama_karari":
            return "Kamu kurum ve kuruluÅŸlarÄ±nda personel atama iÅŸlemleri gerÃ§ekleÅŸtirilmiÅŸtir. Bu atamalar, kurumsal yapÄ±lanma ve yÃ¶netim kadrolarÄ± aÃ§Ä±sÄ±ndan Ã¶nem taÅŸÄ±maktadÄ±r."
        elif category == "genelge":
            return "Ä°lgili kurum tarafÄ±ndan yayÄ±mlanan genelge ile uygulama birliÄŸi saÄŸlanmasÄ± ve prosedÃ¼rlerin netleÅŸtirilmesi amaÃ§lanmÄ±ÅŸtÄ±r."
        elif category == "gunluk_sayi":
            return f"{self.gazette_date.strftime('%d.%m.%Y')} tarihli Resmi Gazete gÃ¼nlÃ¼k sayÄ±sÄ± yayÄ±mlanmÄ±ÅŸtÄ±r. Bu sayÄ±da yer alan tÃ¼m dÃ¼zenlemelere PDF formatÄ±nda eriÅŸebilirsiniz."
        else:
            return f"{self.get_category_display()} kapsamÄ±nda yapÄ±lan bu dÃ¼zenleme, ilgili mevzuat ve uygulamalar aÃ§Ä±sÄ±ndan gÃ¼ncel geliÅŸmeleri iÃ§ermektedir."


class EmailSubscription(models.Model):
    """Kullanici email abonelik tercihleri"""
    FREQUENCY_CHOICES = [
        ("daily", "Gunluk"),
        ("weekly", "Haftalik"),
        ("disabled", "Kapali"),
    ]
    
    user = models.OneToOneField(User, on_delete=models.CASCADE, related_name="gazette_subscription")
    
    # Abonelik Durumu
    is_active = models.BooleanField("Aktif", default=True)
    frequency = models.CharField("Siklik", max_length=10, choices=FREQUENCY_CHOICES, default="daily")
    
    # Email Tercihleri
    send_time = models.TimeField("Gonderim Saati", default="08:00", help_text="Gunluk email gonderim saati")
    
    # Sistem Bilgileri
    created_at = models.DateTimeField("Olusturulma Tarihi", auto_now_add=True)
    updated_at = models.DateTimeField("Guncelleme Tarihi", auto_now=True)
    last_email_sent = models.DateTimeField("Son Email Tarihi", blank=True, null=True)
    
    class Meta:
        verbose_name = "Email Aboneligi"
        verbose_name_plural = "Email Abonelikleri"
    
    def __str__(self):
        status = "Aktif" if self.is_active else "Pasif"
        return f"{self.user.username} - {self.get_frequency_display()} ({status})"


class DailyEmailSent(models.Model):
    """Gonderilen gunluk email kayitlari"""
    EMAIL_STATUS_CHOICES = [
        ("sent", "Gonderildi"),
        ("failed", "Basarisiz"),
        ("pending", "Beklemede"),
    ]
    
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name="sent_gazette_emails")
    email_date = models.DateField("Email Tarihi")
    gazette_date = models.DateField("Resmi Gazete Tarihi")
    
    # Email Icerigi
    subject = models.CharField("Baslik", max_length=200)
    content_count = models.IntegerField("Icerik Sayisi", default=0)
    
    # Gonderim Bilgileri
    sent_at = models.DateTimeField("Gonderilme Tarihi", auto_now_add=True)
    status = models.CharField("Durum", max_length=10, choices=EMAIL_STATUS_CHOICES, default="sent")
    error_message = models.TextField("Hata Mesaji", blank=True, null=True)
    
    class Meta:
        verbose_name = "Gonderilen Email"
        verbose_name_plural = "Gonderilen Email ler"
        ordering = ["-email_date", "-sent_at"]
        unique_together = ["user", "email_date"]
    
    def __str__(self):
        return f"{self.user.username} - {self.email_date.strftime('%d.%m.%Y')} ({self.get_status_display()})"

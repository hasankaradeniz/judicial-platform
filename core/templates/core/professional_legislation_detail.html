{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ legislation.title }}{% endblock %}

{% block extra_css %}
<style>
.legislation-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 40px 0;
    margin-bottom: 30px;
}

.legislation-info-card {
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    padding: 20px;
    backdrop-filter: blur(10px);
}

.article-card {
    border-left: 4px solid #007bff;
    transition: all 0.3s ease;
    margin-bottom: 25px;
}

.article-card:hover {
    border-left-color: #0056b3;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.article-number-badge {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 16px;
    margin-right: 20px;
    flex-shrink: 0;
}

.article-content {
    line-height: 1.8;
    text-align: justify;
}

.search-highlight {
    background: linear-gradient(120deg, #f093fb 0%, #f5576c 100%);
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: bold;
}

.stats-card {
    background: white;
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
}

.stats-card:hover {
    transform: translateY(-5px);
}

.btn-modern {
    border-radius: 25px;
    padding: 12px 25px;
    font-weight: 500;
    transition: all 0.3s ease;
    border: none;
}

.btn-modern:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
}

.search-container {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.breadcrumb-modern {
    background: transparent;
    padding: 0;
    margin-bottom: 20px;
}

.breadcrumb-modern .breadcrumb-item + .breadcrumb-item::before {
    content: "›";
    color: #6c757d;
}

.toc {
    position: sticky;
    top: 20px;
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    max-height: 70vh;
    overflow-y: auto;
}
</style>
{% endblock %}

{% block content %}
<div class="legislation-header">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb breadcrumb-modern">
                <li class="breadcrumb-item"><a href="{% url 'professional_legislation_home' %}" class="text-white">Ana Sayfa</a></li>
                <li class="breadcrumb-item"><a href="{% url 'professional_legislation_list' %}" class="text-white">Mevzuat</a></li>
                <li class="breadcrumb-item active text-white-50" aria-current="page">{{ legislation.number }}</li>
            </ol>
        </nav>
        
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="mb-3">
                    <span class="badge badge-light mr-2">{{ legislation.legislation_type.name }}</span>
                    {% if legislation.category %}
                        <span class="badge badge-secondary mr-2">{{ legislation.category.name }}</span>
                    {% endif %}
                    <span class="badge badge-success">{{ legislation.get_status_display }}</span>
                </div>
                
                <h1 class="display-4 mb-3">{{ legislation.title }}</h1>
                
                {% if legislation.short_title and legislation.short_title != legislation.title %}
                    <h4 class="text-white-50">{{ legislation.short_title }}</h4>
                {% endif %}
            </div>
            <div class="col-md-4">
                <div class="legislation-info-card">
                    <div class="row text-center">
                        {% if legislation.number %}
                            <div class="col-6">
                                <h3 class="mb-0">{{ legislation.number }}</h3>
                                <small>Kanun No</small>
                            </div>
                        {% endif %}
                        <div class="col-6">
                            <h3 class="mb-0">{{ legislation.articles.count }}</h3>
                            <small>Madde</small>
                        </div>
                    </div>
                    
                    {% if legislation.effective_date %}
                        <div class="mt-3 text-center">
                            <small>Yürürlük: {{ legislation.effective_date|date:"d.m.Y" }}</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-lg-3">
            <!-- İçindekiler -->
            <div class="toc">
                <h5><i class="fas fa-list"></i> İçindekiler</h5>
                <div class="list-group list-group-flush">
                    {% for article in articles|slice:":10" %}
                        <a href="#article-{{ article.id }}" class="list-group-item list-group-item-action border-0 py-2">
                            <small>Madde {{ article.article_number }}</small>
                            {% if article.title %}
                                <br><span class="text-muted" style="font-size: 11px;">{{ article.title|truncatewords:4 }}</span>
                            {% endif %}
                        </a>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="col-lg-9">
            <!-- Mevzuat Detay Bilgileri -->
            <div class="row mb-4">
                {% if legislation.official_gazette_date %}
                    <div class="col-md-3">
                        <div class="stats-card">
                            <i class="fas fa-calendar-alt text-primary mb-2" style="font-size: 24px;"></i>
                            <h6>RG Tarihi</h6>
                            <p class="mb-0">{{ legislation.official_gazette_date|date:"d.m.Y" }}</p>
                        </div>
                    </div>
                {% endif %}
                {% if legislation.official_gazette_number %}
                    <div class="col-md-3">
                        <div class="stats-card">
                            <i class="fas fa-newspaper text-success mb-2" style="font-size: 24px;"></i>
                            <h6>RG Sayısı</h6>
                            <p class="mb-0">{{ legislation.official_gazette_number }}</p>
                        </div>
                    </div>
                {% endif %}
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="fas fa-eye text-info mb-2" style="font-size: 24px;"></i>
                        <h6>Görüntülenme</h6>
                        <p class="mb-0">{{ legislation.view_count }}</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="fas fa-file-alt text-warning mb-2" style="font-size: 24px;"></i>
                        <h6>Toplam Madde</h6>
                        <p class="mb-0">{{ legislation.articles.count }}</p>
                    </div>
                </div>
            </div>
            
            {% if legislation.summary %}
                <div class="card mb-4">
                    <div class="card-body">
                        <h5><i class="fas fa-info-circle text-primary"></i> Özet</h5>
                        <p class="mb-0">{{ legislation.summary }}</p>
                    </div>
                </div>
            {% endif %}
            
            <!-- İşlem Butonları -->
            <div class="text-center mb-4">
                {% if legislation.pdf_url %}
                    <a href="{{ legislation.pdf_url }}" target="_blank" class="btn btn-danger btn-modern">
                        <i class="fas fa-file-pdf"></i> PDF İndir
                    </a>
                {% endif %}
                <button class="btn btn-primary btn-modern" onclick="window.print()">
                    <i class="fas fa-print"></i> Yazdır
                </button>
                <button class="btn btn-success btn-modern" onclick="copyUrl()">
                    <i class="fas fa-share"></i> Paylaş
                </button>
            </div>
            
            <!-- Madde İçi Arama -->
            <div class="search-container">
                <form id="article-search-form">
                    <div class="input-group input-group-lg">
                        <input type="text" 
                               class="form-control border-0" 
                               id="article-search-input"
                               placeholder="Bu mevzuat içinde madde ara..." 
                               style="background: #f8f9fa;">
                        <div class="input-group-append">
                            <button type="submit" class="btn btn-primary btn-modern">
                                <i class="fas fa-search"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-modern" id="clear-search">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Maddeler -->
            <div class="articles-container">
                {% for article in articles %}
                    <div class="card article-card" id="article-{{ article.id }}">
                        <div class="card-body">
                            <div class="d-flex">
                                <div class="article-number-badge">
                                    {{ article.article_number }}
                                </div>
                                <div class="flex-grow-1">
                                    {% if article.title %}
                                        <h5 class="mb-3 text-primary">{{ article.title }}</h5>
                                    {% endif %}
                                    
                                    {% if article.is_repealed %}
                                        <div class="alert alert-warning mb-3">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            Bu madde yürürlükten kaldırılmıştır.
                                        </div>
                                    {% endif %}
                                    
                                    <div class="article-content">
                                        {% if article.text_html %}
                                            {{ article.text_html|safe }}
                                        {% else %}
                                            {{ article.text|linebreaksbr }}
                                        {% endif %}
                                    </div>
                                    
                                    {% if article.footnotes %}
                                        <div class="mt-3 p-3 bg-light rounded">
                                            <small class="text-muted">
                                                <i class="fas fa-sticky-note"></i>
                                                <strong>Dipnot:</strong> {{ article.footnotes }}
                                            </small>
                                        </div>
                                    {% endif %}
                                    
                                    {% if article.legal_notes %}
                                        <div class="alert alert-info mt-3">
                                            <small>
                                                <i class="fas fa-balance-scale"></i>
                                                <strong>Hukuki Not:</strong> {{ article.legal_notes }}
                                            </small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle"></i>
                        Bu mevzuatın madde metinleri henüz sisteme yüklenmemiştir.
                    </div>
                {% endfor %}
            </div>
            
            <!-- Sayfalama -->
            {% if articles.has_other_pages %}
                <nav aria-label="Sayfalama" class="mt-5">
                    <ul class="pagination justify-content-center">
                        {% if articles.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ articles.previous_page_number }}">
                                    <i class="fas fa-chevron-left"></i> Önceki
                                </a>
                            </li>
                        {% endif %}
                        
                        {% for num in articles.paginator.page_range %}
                            {% if num == articles.number %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% else %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if articles.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ articles.next_page_number }}">
                                    Sonraki <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Smooth scroll for TOC links
    document.querySelectorAll('a[href^="#article-"]').forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });
    
    // Article search functionality
    document.getElementById('article-search-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const query = document.getElementById('article-search-input').value.toLowerCase().trim();
        if (query) searchInArticles(query);
    });
    
    document.getElementById('clear-search').addEventListener('click', function() {
        document.getElementById('article-search-input').value = '';
        clearHighlights();
    });
    
    // Increment view count
    fetch('{% url "increment_legislation_view" legislation.id %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    });
});

function searchInArticles(query) {
    clearHighlights();
    
    const articles = document.querySelectorAll('.article-card');
    let foundCount = 0;
    
    articles.forEach(function(article) {
        const text = article.textContent.toLowerCase();
        if (text.includes(query)) {
            article.style.display = 'block';
            highlightText(article, query);
            foundCount++;
        } else {
            article.style.display = 'none';
        }
    });
    
    showSearchResult(foundCount, query);
}

function clearHighlights() {
    document.querySelectorAll('.search-highlight').forEach(function(highlight) {
        highlight.outerHTML = highlight.textContent;
    });
    
    document.querySelectorAll('.article-card').forEach(function(article) {
        article.style.display = 'block';
    });
    
    const existingResult = document.querySelector('.search-result-info');
    if (existingResult) existingResult.remove();
}

function highlightText(element, query) {
    const walker = document.createTreeWalker(
        element,
        NodeFilter.SHOW_TEXT,
        null,
        false
    );
    
    const textNodes = [];
    let node;
    while (node = walker.nextNode()) {
        textNodes.push(node);
    }
    
    textNodes.forEach(function(textNode) {
        if (textNode.textContent.toLowerCase().includes(query)) {
            const parent = textNode.parentNode;
            const regex = new RegExp(`(${query})`, 'gi');
            const html = textNode.textContent.replace(regex, '<span class="search-highlight">$1</span>');
            
            const wrapper = document.createElement('span');
            wrapper.innerHTML = html;
            parent.replaceChild(wrapper, textNode);
        }
    });
}

function showSearchResult(count, query) {
    const container = document.querySelector('.articles-container');
    const resultDiv = document.createElement('div');
    resultDiv.className = 'alert alert-info search-result-info';
    resultDiv.innerHTML = `
        <i class="fas fa-search"></i>
        "<strong>${query}</strong>" için <strong>${count}</strong> madde bulundu.
        <button type="button" class="close" onclick="this.parentElement.remove()">
            <span>&times;</span>
        </button>
    `;
    
    container.insertBefore(resultDiv, container.firstChild);
}

function copyUrl() {
    navigator.clipboard.writeText(window.location.href).then(function() {
        // Toast notification
        const toast = document.createElement('div');
        toast.className = 'alert alert-success position-fixed';
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
        toast.innerHTML = '<i class="fas fa-check"></i> URL kopyalandı!';
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => document.body.removeChild(toast), 300);
        }, 2000);
    });
}
</script>
{% endblock %}
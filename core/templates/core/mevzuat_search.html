{% extends "core/base.html" %}
{% load static %}

{% block page_title %}Mevzuat Arama - Lexatech{% endblock %}

{% block extra_styles %}
<style>
  :root {
    --primary: #1e40af;
    --primary-dark: #1e3a8a;
    --secondary: #64748b;
    --accent: #f59e0b;
    --success: #10b981;
    --danger: #ef4444;
    --light-gray: #f8fafc;
    --border: #e2e8f0;
    --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
  }

  * {
    box-sizing: border-box;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    margin: 0;
    padding: 0;
  }

  .main-container {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* Header */
  .header {
    background: white;
    box-shadow: var(--shadow);
    padding: 1rem 0;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .header-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .logo {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--primary);
    text-decoration: none;
  }

  .header-nav {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .header-nav a {
    color: var(--secondary);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.2s;
  }

  .header-nav a:hover {
    color: var(--primary);
  }

  /* Hero Search Section */
  .hero-section {
    background: white;
    padding: 3rem 0;
    text-align: center;
  }

  .hero-content {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .hero-title {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 0.5rem;
  }

  .hero-subtitle {
    font-size: 1.125rem;
    color: var(--secondary);
    margin-bottom: 2rem;
  }

  .search-container {
    position: relative;
    margin-bottom: 2rem;
  }

  .search-input {
    width: 100%;
    padding: 1rem 1.5rem 1rem 3rem;
    border: 2px solid var(--border);
    border-radius: 50px;
    font-size: 1.125rem;
    background: white;
    transition: all 0.3s ease;
    box-shadow: var(--shadow);
  }

  .search-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: var(--shadow-lg), 0 0 0 3px rgb(30 64 175 / 0.1);
  }

  .search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--secondary);
  }

  .search-button {
    position: absolute;
    right: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }

  .search-button:hover {
    background: var(--primary-dark);
  }

  /* Search Suggestions */
  .search-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid var(--border);
    border-radius: 1rem;
    box-shadow: var(--shadow-lg);
    margin-top: 0.5rem;
    display: none;
    z-index: 50;
  }

  .search-suggestions.active {
    display: block;
  }

  .suggestion-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid var(--border);
    transition: background 0.2s;
  }

  .suggestion-item:hover {
    background: var(--light-gray);
  }

  .suggestion-item:last-child {
    border-bottom: none;
  }

  /* Quick Filters */
  .quick-filters {
    display: flex;
    justify-content: center;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 2rem;
  }

  .filter-btn {
    padding: 0.5rem 1rem;
    border: 2px solid var(--border);
    border-radius: 50px;
    background: white;
    color: var(--secondary);
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s;
    cursor: pointer;
  }

  .filter-btn:hover,
  .filter-btn.active {
    border-color: var(--primary);
    color: var(--primary);
    background: rgb(30 64 175 / 0.05);
  }

  /* Popular Searches */
  .popular-searches {
    text-align: center;
    color: var(--secondary);
  }

  .popular-searches h3 {
    margin-bottom: 1rem;
    font-size: 1rem;
    font-weight: 600;
  }

  .popular-tags {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .popular-tag {
    padding: 0.25rem 0.75rem;
    background: var(--light-gray);
    color: var(--secondary);
    border-radius: 50px;
    text-decoration: none;
    font-size: 0.875rem;
    transition: all 0.2s;
  }

  .popular-tag:hover {
    background: var(--primary);
    color: white;
  }

  /* Results Section */
  .results-section {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
    flex: 1;
  }

  .results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border);
  }

  .results-count {
    font-weight: 600;
    color: var(--secondary);
  }

  .results-filters {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .sort-select {
    padding: 0.5rem;
    border: 1px solid var(--border);
    border-radius: 0.5rem;
    background: white;
  }

  /* Result Cards */
  .results-grid {
    display: grid;
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .result-card {
    background: white;
    border-radius: 1rem;
    padding: 1.5rem;
    box-shadow: var(--shadow);
    transition: all 0.2s;
    border: 1px solid var(--border);
  }

  .result-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
  }

  .result-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
  }

  .result-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--primary);
    text-decoration: none;
    line-height: 1.4;
    margin: 0;
  }

  .result-title:hover {
    color: var(--primary-dark);
  }

  .result-type {
    background: var(--accent);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .result-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
    padding: 1rem;
    background: var(--light-gray);
    border-radius: 0.5rem;
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--secondary);
  }

  .meta-label {
    font-weight: 600;
    color: var(--primary);
  }

  .result-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
  }

  .action-btn {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border);
    border-radius: 0.5rem;
    background: white;
    color: var(--secondary);
    text-decoration: none;
    font-size: 0.875rem;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .action-btn:hover {
    border-color: var(--primary);
    color: var(--primary);
  }

  /* Pagination */
  .pagination {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 2rem;
  }

  .page-btn {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border);
    border-radius: 0.5rem;
    background: white;
    color: var(--secondary);
    text-decoration: none;
    transition: all 0.2s;
  }

  .page-btn:hover,
  .page-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }

  /* Loading States */
  .loading {
    text-align: center;
    padding: 3rem;
    color: var(--secondary);
  }

  .spinner {
    width: 2rem;
    height: 2rem;
    border: 3px solid var(--border);
    border-top: 3px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* No Results */
  .no-results {
    text-align: center;
    padding: 3rem;
    color: var(--secondary);
  }

  .no-results-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.3;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .hero-title {
      font-size: 2rem;
    }

    .search-input {
      font-size: 1rem;
    }

    .quick-filters {
      gap: 0.5rem;
    }

    .results-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }

    .result-meta {
      grid-template-columns: 1fr;
    }

    .header-nav {
      display: none;
    }
  }

  @media (max-width: 480px) {
    .hero-content {
      padding: 0 0.5rem;
    }

    .search-input {
      padding: 0.875rem 1rem 0.875rem 2.5rem;
    }

    .search-button {
      position: static;
      transform: none;
      margin-top: 1rem;
      width: 100%;
      border-radius: 0.5rem;
    }

    .search-container {
      position: static;
    }
  }

  /* Utility Classes */
  .hidden { display: none !important; }
  .text-center { text-align: center; }
  .mb-0 { margin-bottom: 0; }
  .mt-2 { margin-top: 0.5rem; }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <a href="{% url 'home' %}" class="logo">
        <i class="fas fa-scale-balanced"></i> Lexatech
      </a>
      <nav class="header-nav">
        <a href="{% url 'home' %}">Ana Sayfa</a>
        <a href="{% url 'judicial_decisions' %}">ƒ∞√ßtihatlar</a>
        <a href="#" class="active">Mevzuat</a>
        {% if user.is_authenticated %}
          <a href="{% url 'logout' %}">√áƒ±kƒ±≈ü</a>
        {% else %}
          <a href="{% url 'login' %}">Giri≈ü</a>
        {% endif %}
      </nav>
    </div>
  </header>

  <!-- Hero Search Section -->
  <section class="hero-section" id="search-section">
    <div class="hero-content">
      <h1 class="hero-title">T√ºrkiye Mevzuat Arama</h1>
      <p class="hero-subtitle">
        Kanunlar, y√∂netmelikler ve tebliƒülerde akƒ±llƒ± arama yapƒ±n
      </p>

      <!-- Search Form -->
      <form class="search-container" id="search-form">
        <i class="fas fa-search search-icon"></i>
        <input 
          type="text" 
          class="search-input" 
          id="search-input"
          placeholder="√ñrn: 5846, t√ºketici, medeni kanun, ticaret..."
          autocomplete="off"
        >
        <button type="submit" class="search-button">
          <i class="fas fa-search"></i> Ara
        </button>

        <!-- Search Suggestions -->
        <div class="search-suggestions" id="search-suggestions">
          <!-- Dynamic suggestions will be added here -->
        </div>
      </form>

      <!-- Quick Filters -->
      <div class="quick-filters">
        <button class="filter-btn active" data-type="all">
          <i class="fas fa-list"></i> T√ºm√º
        </button>
        <button class="filter-btn" data-type="KANUN">
          <i class="fas fa-gavel"></i> Kanunlar
        </button>
        <button class="filter-btn" data-type="YONETMELIK">
          <i class="fas fa-file-alt"></i> Y√∂netmelikler  
        </button>
        <button class="filter-btn" data-type="TEBLIGLER">
          <i class="fas fa-bullhorn"></i> Tebliƒüler
        </button>
      </div>

      <!-- Popular Searches -->
      <div class="popular-searches">
        <h3>Pop√ºler Aramalar</h3>
        <div class="popular-tags">
          <a href="#" class="popular-tag" data-search="t√ºketici">T√ºketici Haklarƒ±</a>
          <a href="#" class="popular-tag" data-search="4721">Medeni Kanun</a>
          <a href="#" class="popular-tag" data-search="4857">ƒ∞≈ü Kanunu</a>
          <a href="#" class="popular-tag" data-search="5846">Fikir ve Sanat Eserleri</a>
          <a href="#" class="popular-tag" data-search="6769">Sƒ±nai M√ºlkiyet</a>
          <a href="#" class="popular-tag" data-search="6102">Ticaret Kanunu</a>
        </div>
      </div>
    </div>
  </section>

  <!-- Results Section -->
  <section class="results-section hidden" id="results-section">
    <!-- Results Header -->
    <div class="results-header">
      <div class="results-count" id="results-count">
        <!-- Dynamic count -->
      </div>
      <div class="results-filters">
        <select class="sort-select" id="sort-select">
          <option value="RESMI_GAZETE_TARIHI">Yayƒ±n Tarihine G√∂re</option>
          <option value="MEVZUAT_NUMARASI">Mevzuat Numarasƒ±na G√∂re</option>
          <option value="relevance">ƒ∞lgiye G√∂re</option>
        </select>
      </div>
    </div>

    <!-- Loading State -->
    <div class="loading hidden" id="loading-state">
      <div class="spinner"></div>
      <p>Mevzuat aranƒ±yor...</p>
    </div>

    <!-- No Results -->
    <div class="no-results hidden" id="no-results">
      <div class="no-results-icon">üîç</div>
      <h3>Sonu√ß bulunamadƒ±</h3>
      <p>Arama teriminizi deƒüi≈ütirip tekrar deneyebilirsiniz.</p>
    </div>

    <!-- Results Grid -->
    <div class="results-grid" id="results-grid">
      <!-- Dynamic results will be added here -->
    </div>

    <!-- Pagination -->
    <div class="pagination" id="pagination">
      <!-- Dynamic pagination will be added here -->
    </div>
  </section>
</div>

<!-- CSRF Token -->
{% csrf_token %}

<script>
// Global variables
let currentPage = 1;
let currentQuery = '';
let currentFilter = 'all';
let currentSort = 'RESMI_GAZETE_TARIHI';

// DOM Elements
const searchForm = document.getElementById('search-form');
const searchInput = document.getElementById('search-input');
const searchSuggestions = document.getElementById('search-suggestions');
const filterButtons = document.querySelectorAll('.filter-btn');
const popularTags = document.querySelectorAll('.popular-tag');
const heroSection = document.getElementById('search-section');
const resultsSection = document.getElementById('results-section');
const resultsGrid = document.getElementById('results-grid');
const resultsCount = document.getElementById('results-count');
const loadingState = document.getElementById('loading-state');
const noResults = document.getElementById('no-results');
const sortSelect = document.getElementById('sort-select');

// Utility Functions
function getCSRFToken() {
  return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Search Functions
async function performSearch(query, page = 1, showLoading = true) {
  if (!query.trim()) return;

  currentQuery = query;
  currentPage = page;

  if (showLoading) {
    showLoadingState();
  }

  try {
    const response = await fetch('/api/search/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify({
        query: query,
        page: page,
        page_size: 10,
        sort_field: currentSort,
        sort_direction: 'desc',
        mevzuat_tur: currentFilter !== 'all' ? currentFilter : null
      })
    });

    const data = await response.json();
    
    if (data.success) {
      displayResults(data.data);
    } else {
      showError(data.message || 'Arama hatasƒ±');
    }

  } catch (error) {
    console.error('Search error:', error);
    showError('Arama sƒ±rasƒ±nda hata olu≈ütu');
  }
}

function displayResults(data) {
  hideLoadingState();
  showResultsSection();

  const { documents, total_count, page, total_pages } = data;

  // Update results count
  resultsCount.textContent = `${total_count} sonu√ß bulundu`;

  if (documents.length === 0) {
    showNoResults();
    return;
  }

  // Clear previous results
  resultsGrid.innerHTML = '';

  // Display results
  documents.forEach(doc => {
    const card = createResultCard(doc);
    resultsGrid.appendChild(card);
  });

  // Update pagination
  updatePagination(page, total_pages);

  // Hide no results
  noResults.classList.add('hidden');
}

function createResultCard(doc) {
  const card = document.createElement('div');
  card.className = 'result-card';

  const typeColors = {
    'KANUN': '#ef4444',
    'YONETMELIK': '#3b82f6', 
    'TEBLIGLER': '#10b981',
    'CB_KARARNAME': '#f59e0b',
    'TUZUK': '#8b5cf6'
  };

  const typeColor = typeColors[doc.mevzuat_tur] || '#64748b';

  card.innerHTML = `
    <div class="result-header">
      <h3 class="result-title">
        <a href="#" onclick="viewDocument('${doc.id}'); return false;">${doc.baslik}</a>
      </h3>
      <span class="result-type" style="background-color: ${typeColor}">
        ${doc.mevzuat_tur || 'MEVZUAT'}
      </span>
    </div>

    <div class="result-meta">
      ${doc.mevzuat_no ? `
        <div class="meta-item">
          <span class="meta-label">Numara:</span>
          <span>${doc.mevzuat_no}</span>
        </div>
      ` : ''}
      
      ${doc.resmi_gazete_tarihi ? `
        <div class="meta-item">
          <span class="meta-label">R.G. Tarihi:</span>
          <span>${new Date(doc.resmi_gazete_tarihi).toLocaleDateString('tr-TR')}</span>
        </div>
      ` : ''}

      ${doc.resmi_gazete_no ? `
        <div class="meta-item">
          <span class="meta-label">R.G. Sayƒ±sƒ±:</span>
          <span>${doc.resmi_gazete_no}</span>
        </div>
      ` : ''}

      <div class="meta-item">
        <span class="meta-label">Kaynak:</span>
        <span>Adalet Bakanlƒ±ƒüƒ±</span>
      </div>
    </div>

    <div class="result-actions">
      <a href="#" class="action-btn" onclick="viewDocument('${doc.id}'); return false;">
        <i class="fas fa-eye"></i> G√∂r√ºnt√ºle
      </a>
      <a href="${doc.url}" target="_blank" class="action-btn">
        <i class="fas fa-file-pdf"></i> PDF
      </a>
      <a href="#" class="action-btn" onclick="showArticles('${doc.id}')">
        <i class="fas fa-list"></i> Maddeler
      </a>
    </div>
  `;

  return card;
}

function updatePagination(currentPage, totalPages) {
  const pagination = document.getElementById('pagination');
  pagination.innerHTML = '';

  if (totalPages <= 1) return;

  // Previous button
  if (currentPage > 1) {
    const prevBtn = document.createElement('a');
    prevBtn.className = 'page-btn';
    prevBtn.href = '#';
    prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
    prevBtn.onclick = (e) => {
      e.preventDefault();
      performSearch(currentQuery, currentPage - 1);
    };
    pagination.appendChild(prevBtn);
  }

  // Page numbers
  const startPage = Math.max(1, currentPage - 2);
  const endPage = Math.min(totalPages, currentPage + 2);

  for (let i = startPage; i <= endPage; i++) {
    const pageBtn = document.createElement('a');
    pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
    pageBtn.href = '#';
    pageBtn.textContent = i;
    pageBtn.onclick = (e) => {
      e.preventDefault();
      if (i !== currentPage) {
        performSearch(currentQuery, i);
      }
    };
    pagination.appendChild(pageBtn);
  }

  // Next button
  if (currentPage < totalPages) {
    const nextBtn = document.createElement('a');
    nextBtn.className = 'page-btn';
    nextBtn.href = '#';
    nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
    nextBtn.onclick = (e) => {
      e.preventDefault();
      performSearch(currentQuery, currentPage + 1);
    };
    pagination.appendChild(nextBtn);
  }
}

// UI State Functions
function showLoadingState() {
  loadingState.classList.remove('hidden');
  resultsGrid.classList.add('hidden');
  noResults.classList.add('hidden');
}

function hideLoadingState() {
  loadingState.classList.add('hidden');
  resultsGrid.classList.remove('hidden');
}

function showResultsSection() {
  heroSection.style.padding = '1rem 0';
  resultsSection.classList.remove('hidden');
}

function showNoResults() {
  resultsGrid.classList.add('hidden');
  noResults.classList.remove('hidden');
}

function showError(message) {
  hideLoadingState();
  alert('Hata: ' + message);
}

// Document Actions
function viewDocument(docId) {
  console.log('Viewing document:', docId);
  // Doƒürudan PDF a√ßma veya ba≈üka bir g√∂r√ºnt√ºleme y√∂ntemi eklenebilir
  const card = event.target.closest('.result-card');
  const pdfUrl = card.querySelector('.action-btn[href*="pdf"]').href;
  if (pdfUrl) {
    window.open(pdfUrl, '_blank');
  }
}

function showArticles(docId) {
  console.log('Showing articles for:', docId);
  // TODO: Implement article tree
  alert('Madde listesi √∂zelliƒüi yakƒ±nda eklenecek');
}

// Event Listeners
searchForm.addEventListener('submit', (e) => {
  e.preventDefault();
  const query = searchInput.value.trim();
  if (query) {
    performSearch(query);
  }
});

// Filter buttons
filterButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    filterButtons.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.dataset.type;
    
    if (currentQuery) {
      performSearch(currentQuery, 1);
    }
  });
});

// Popular tags
popularTags.forEach(tag => {
  tag.addEventListener('click', (e) => {
    e.preventDefault();
    const query = tag.dataset.search;
    searchInput.value = query;
    performSearch(query);
  });
});

// Sort change
sortSelect.addEventListener('change', () => {
  currentSort = sortSelect.value;
  if (currentQuery) {
    performSearch(currentQuery, 1);
  }
});

// Auto-suggestions (debounced)
const debouncedSuggestions = debounce(async (query) => {
  // TODO: Implement real-time suggestions
  console.log('Getting suggestions for:', query);
}, 300);

searchInput.addEventListener('input', (e) => {
  const query = e.target.value.trim();
  if (query.length >= 2) {
    debouncedSuggestions(query);
  } else {
    searchSuggestions.classList.remove('active');
  }
});

// Hide suggestions when clicking outside
document.addEventListener('click', (e) => {
  if (!searchInput.contains(e.target)) {
    searchSuggestions.classList.remove('active');
  }
});

console.log('üé® Mevzuat Search UI loaded successfully');
</script>
{% endblock %}